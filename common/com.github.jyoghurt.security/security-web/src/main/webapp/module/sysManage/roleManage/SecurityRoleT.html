<!-- Basic Setup Start-->
<style type="text/css">
    .ztree li span.button.linecons-truck_ico_open, .linecons-truck_ico_close, .linecons-truck_ico_docu {
        font-family: linecons;
        font-style: normal;
        font-weight: 400;
        speak: none;
        display: inline-block !important;
        text-decoration: inherit;
        width: 1.2em !important;
        margin-right: .2em !important;
        text-align: center;
        font-variant: normal;
        text-transform: none;
        line-height: 1em !important;
        margin-left: .2em !important;
        background-image: none !important;
    }

    .linecons-truck_ico_open:before, .linecons-truck_ico_close:before, .linecons-truck_ico_docu:before {
        content: '\e829';
    }

</style>
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">角色管理</h3>


    </div>
    <div class="panel-body">
        <table id="table" class="table  table-bordered table-hover" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>id</th>
                <th>角色名称</th>
                <th>角色类型</th>
                <th>所属组织机构</th>
                <th class="width130">操作</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <script type="text/javascript">
            (function ($) {
                /**
                 *编辑或者新建 逻辑判断 无后台
                 * rowdata 行数据
                 */
                function editRow(rowdata) {
                    $("#forRoleId").val('');
                    if (rowdata) {

                        $("#forRoleId").val(rowdata.roleId);
                    }

                    //编辑还是保存
                    var flag = rowdata ? true : false;

                    //如果是新增操作
                    if (flag) {
                        /*设置状态为修改*/
                        $("#operType").val("0");
                        //弹出菜单的业务逻辑方法
                        function saveHandler(modal) {
                            saveOrUPdate(modal, flag, function (data, status) {
                                DF.toast.success(data.message);
                                DF.hideModal(modal);
                                reloadGrid();
                            });
                        }

                        //modal窗口的配置项目
                        var config = {
                            dom: $('#securityRoleTForm'),
                            title: flag ? '编辑页面' : '新建页面',
                            cache: false,
                            btns: [{
                                text: '保存',
                                icon: 'btn-info',
                                fn: saveHandler
                            }]
                        };
                        DF.showModal(config, function (modal) {

                            /*回调函数中的参数
                             * modal为当前的模块窗口 其中提供 getForm()方法 返回 业务的form 此form为 jq对象
                             */
                            flag && loadForm(modal, rowdata);
                        });
                    } else {
                        /*设置状态为新增*/
                        $("#operType").val("1");
                        //弹出菜单的业务逻辑方法
                        function saveHandler(modal) {
                            saveOrUPdate(modal, flag, function (data, status) {
                                DF.toast.success(data.message);
                                DF.hideModal(modal);
                                reloadGrid();
                            });
                        }

                        //modal窗口的配置项目
                        var config = {
                            dom: $('#securityRoleTForm'),
                            title: flag ? '编辑页面' : '新建页面',
                            cache: false,
                            btns: [{
                                text: '保存',
                                icon: 'btn-info',
                                fn: saveHandler
                            }]
                        };
                        DF.showModal(config, function (modal) {
                            /*回调函数中的参数
                             * modal为当前的模块窗口 其中提供 getForm()方法 返回 业务的form 此form为 jq对象
                             */
                            flag && loadForm(modal, rowdata);
                        });
                    }


                };
                //删除 走后台
                function deleteRow(rowdata) {
                    if (rowdata.roleId == '7d6007e5-9659-441d-be00-5ro484f8856d') {
                        DF.toast.error("系统超级管理员角色，无法删除！");
                        return;
                    }


                    function checkFn(data, status) {
                        //提示信息
                        var info = "";
                        var sfn = function (data, status) {
                            reloadGrid();
                            DF.toast.success(data.message);
                        };
                        if (data.result == '0') {
                            info = "确认删除？";
                        }else{
                            info = data.result;
                        }

                        if (confirm(info)) {
                            DF.ajax({
                                url: 'service/securityRoleT/' + rowdata.roleId,
                                type: 'DELETE',
                                success: sfn
                            });
                        }
                    }

                    DF.ajax({
                        url: 'service/securityRoleT/deleteCheck/' + rowdata.roleId,
                        type: 'GET',
                        success: checkFn
                    });


                };
                //加载列表  走后台
                function reloadGrid() {
                    grid.ajax.reload();
                };
                //加载表单  如果rowdata 数据满足  可以直接赋值 不用走后台
                function loadForm(modal, rowdata) {
                    var form = modal.getForm();
                    if (rowdata) {
                        DF.setFormValues(rowdata, form);
                    }
                };
                //保存表单or编辑表单  走后台
                function saveOrUPdate(modal, flag, fn) {
                    var form = modal.getForm();
                    var data = form.serializeObject();
                    var checkedNode = _treeMenu.getCheckedNodes(true);
                    var menus = new Array();
                    if (checkedNode) {
                        for (var i = 0; i < checkedNode.length; i++) {
                            menus.push(checkedNode[i].id);
                        }
                    }
                    data.menus = menus.toString();
                    data.menuTs = data.menus;
                    delete data.menus;
                    var url = flag ? 'service/securityRoleT/editRole' : 'service/securityRoleT/addRole';
                    var sfn = function (data, status) {
                        fn && fn(data, status);
                    };
                    DF.ajax({
                        data: JSON.stringify(data),
                        type: flag ? 'PUT' : 'POST',
                        url: url,
                        success: sfn
                    });

                };
                var grid = DF.dataTable({
                    id: "table",
                    ajax: "service/securityRoleT/list",
                    joinColumn:false,
                    rowbtns: [
                        {
                            text: '编辑',
                            name: 'edit',
                            class: 'btn-success',
                            displayKey: 'btrow',
                            displayValue: '0',
                            fn: editRow
                        },
                        {
                            text: '删除',
                            name: 'delete',
                            class: 'btn-danger',
                            displayKey: 'btrow',
                            displayValue: '0',
                            fn: deleteRow
                        }
                    ],
                    toolbtns: [
                        {text: '新建', name: 'create', class: 'btn-success', icon: 'fa fa-plus', fn: editRow},
                    ],
                    columns: [
                        {"data": "roleId", "visible": false, "orderable": false},
                        {"data": "roleName"},
                        {"data": "roleType"},
                        {"data": "belongUnitName", "bSortable": false}
                    ],
                    columnDefs: [
                        {
                            render: function (data, type, row) {
                                return data == 0 ? "超级管理员角色" : data == 1 ? "系统角色" : "自定义角色";
                            },
                            "targets": 2
                        }],
                    createdRow: function (row, data, index) {
                        $('td', row).click(function () {
                        })
                    },

                    //重新加载
                    reloadGrid: reloadGrid,
                    //初始化结束后回调
                    initComplete: function () {
                    }
                });


            })(jQuery);
        </script>
        <input style="display:none" id="forRoleId"/>
        <input style="display:none" id="operType"/>
        <!--        <input style="display:none" id="forMenuId"/>-->
    </div>
</div>
<!-- Basic Setup  End-->
<script type="text/template" id="securityRoleTForm">

    <form class="validate">
        <div class="row">
            <div class="col-md-12">
                <div class="form-group hidden">
                    <label class="control-label"></label>
                    <input type="text" name="roleId">
                    <input style="display:none" id="forMenuId" name="menus" required="true"/>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="roleName" class="control-label">角色名称</label>
                    <input type="text" name="roleName" class="form-control" id="roleName"
                           placeholder="" maxlength="20" required="true">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <label for="menuTree" class="control-label">包含菜单</label>

                <div class="DFTree" style="margin-top: 15px;padding: 0 20px;">
                    <!--<div class="input-group input-group-minimal">-->
                    <!--<input type="text" class="form-control" >-->
                    <!--<div class="input-group-addon">-->
                    <!--<a href="javascript:;"><i class="linecons-search"></i></a>-->
                    <!--</div>-->
                    <!--</div>-->
                    <div id="menuTree" class="ztree"></div>
                </div>

            </div>
        </div>
    </form>
    <script type="text/javascript">
        <![CDATA[
        (function ($) {
            var selectData = new Object();
            var humimg = 'linecons-hum';
            var compimg = 'linecons-comp';
            var deptimg = 'linecons-dept';
            var rootimg = 'linecons-root';
            /*=======================================================================所属单位下拉框处理================================================================*/

            //获取菜单树据
            function getData() {
                var treeDate = new Object();
                var ids = $("#forRoleId").val() ? $("#forRoleId").val() : "null";
                var sfn = function (data, status) {
                    //所有节点
                    treeDate = data.result.all;
                    //已选中
                    selectData = data.result.selected;

                    for (var i = 0; i < treeDate.length; i++) {
                        for (var j = 0; j < selectData.length; j++) {
                            if (treeDate[i].menuId == selectData[j].menuId) {
                                treeDate[i].checked = 'true';
                                treeDate[i].open = 'true';
                                break;
                            }
                        }
                    }
                };
                DF.ajax({
                    url: "service/securityMenuT/queryMenuByRoleId/" + ids,
                    type: 'GET',
                    async: false,
                    success: sfn
                });
                return treeDate;
            }

            function processTable(data, idField, foreignKey, rootLevel) {
                var hash = {};
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var id = item[idField];
                    var parentId = item[foreignKey];

                    hash[id] = hash[id] || [];
                    hash[parentId] = hash[parentId] || [];

                    item.children = hash[id];
                    hash[parentId].push(item);
                }
                return hash[rootLevel];
            }


            _treeMenu = DF.zTree({
                id: 'menuTree',
                checkable: true,
                dragable: false,
                treeData: processTable(getData(), "menuId", "parentId", '-1'),
                idKey: 'menuId',
                textKey: 'menuName',
                callback: {},
                onComplete: function (treeObject) {
                }
            });
        })(jQuery);
        ]]>
</script>
</script>

