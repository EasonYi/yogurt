
<!-- Basic Setup Start-->
<div class="panel panel-default">
    <style type="text/css">
        .bootstrap-tagsinput{
            padding-right: 85px;
        }
        .bootstrap-tagsinput label{
            padding: 2px 6px;
        }
        .bootstrap-tagsinput.error{
            border: 1px solid #D05E5E;
        }
    </style>
    <div class="panel-heading">
        <h4 class="panel-title lymsg_tab" id="lymsg_tab_autoReply">
            <a href="javascript:;" type="FOCUS">被关注自动回复</a>
            <a href="javascript:;" type="MESSAGE"> 消息自动回复</a>
            <a href="javascript:;" type="KEYWORDS">关键词自动回复</a>
        </h4>
        <div class="panel-options">
            <button id="save" type="button" class="btn btn-success icon-right">保存 <i class="fa fa-save"></i></button>
            <button id="delete" type="button" class="btn btn-danger icon-right">删除 <i class=""></i></button>
            <button id="add" type="button" class="btn btn-info icon-right hidden">添加 <i class="fa fa-plus"></i></button>
        </div>
    </div>
    <div class="panel panel panel-default" style="padding: 0">
        <div class="panel-body">

            <!-- 自动回复-->
            <div class="col-md-12">

                <div class="row">
                        <div class="lymsg_tab_body " id="onFocusAutoReply">

                        </div>
                        <div class="lymsg_tab_body" id="msgAutoReply">

                        </div>
                        <div class="lymsg_tab_body" id="keywordsAutoReply">

                                <div class="col-sm-12 col-md-3">
                                    <div class="inner mailbox-env" style="min-height: 470px">
                                        <div class="mailbox-sidebar">
                                            <div class="panel-heading">
                                                <h4 class="panel-title"> <a style="color: #222222"> 规则列表</a></h4>
                                            </div>
                                            <ul class="list-unstyled mailbox-list" style="margin-top: 0;" id="leftUl">

                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-9" >
                                <!--<div class="row">-->
                                    <!--<div class="col-xs-12">-->
                                        <!--<button name="create" type="button" class="btn btn-success pull-right icon-right" index="0">新建<i class="fa fa-plus"></i></button>-->
                                    <!--</div>-->
                                <!--</div>-->
                                <form role="form" class="validate" id="autoReplyForm">
                                    <div class="inner">
                                        <div class="panel-heading">
                                            <h4 class="panel-title"> <a style="color: #222222"> 规则详情</a></h4>
                                        </div>
                                        <div class="panel-heading" style="padding:10px 0;border-bottom: none;">
                                            <div>规则名称</div>
                                        </div>
                                        <div class="form-group no-margin">
                                            <label class="control-label" for="ruleName">规则名称</label>
                                            <input type="text" class="form-control" id="ruleName" name="ruleName" required="true" style="padding-right: 100px;">
                                        </div>
                                        <div class="panel-heading" style="border-bottom: none;">
                                            <div>关键字</div>
                                        </div>
                                        <div class="form-group no-margin">
                                            <label class="control-label" for="keyword">关键字</label>
                                        <input type="text" class="form-control" id="keyword" name="keyword" required="true" style="padding-right: 100px;">
                                        </div>
                                        <div class="panel-heading" style="border-bottom: none;">
                                            <div>回复 (可多条)</div>
                                        </div>
                                        <div class="form-group" id="reply">

                                        </div>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>

        </div>
    </div>
</div>
<script type="text/javascript">
    (function ($) {
        var param = DF.getUrlParam();
        var autoResponseId = '',msgId = '',cmtId ='1';
        //显示当前TAB
        function toggleShowTab(index){
            var current = $('.lymsg_tab_body').hide().eq(index);
            current.show();
            //判断组件是否存在 如果存在 销毁
            var comp = DF.getComponent(cmtId);
            comp && comp.destory && comp.destory();
            //文本组件
            if(index!==2){
                current.children().remove();
                DF.create({id:'df_component_msg_autoReply',codes:{'text':1}},current);
                tagsinputTriggerBindError(false);
            //可以选择的组件
            }else{
                cmtId = DF.create({id:'df_component_msg_autoReply',codes:{'text':1,'mpnews':1}},'reply', function (target,exports) {});
            }
            //加载tab里面的内容
            loadTab($('#lymsg_tab_autoReply a.active').attr('type'));
        }
        //根据tab类型加载数据
        function loadTab(type){
            var url = 'weChatAutoResponseT/findAutoResponse/'+param.type+'/'+type;
            DF.ajax({
                type: 'get',
                showLoadingBar:false,
                url: url,
                success: function (data) {
                    setCurrentValue(data.result,type);
                }
            });
        }
        //根据数据加载到页面上
        function setCurrentValue(data,type){
            var index = $('#lymsg_tab_autoReply a.active').index();
            //自动关注 自动回复
            if(type!='KEYWORDS'){
                if(!data.length){
                    autoResponseId = '';
                    msgId = '';
                    $('.lymsg_tab_body').eq(index).find('textarea').val('');
                    return
                }
                var item = data[0].weChatAutoResponseMsgTList[0];
                autoResponseId = item.autoResponseId;
                msgId = item.msgId;
                $('.lymsg_tab_body').eq(index).find('textarea').val(item.content);
             //关键词规则
            }else{
                $('#leftUl').children().remove();
                if(!data.length){
                    $('#add').trigger('click');
                    return
                }
                for(var i=0;i<data.length;i++){
                    var li = $('<li id="'+data[i].autoResponseId+'">');
                    var a = '<a href="javascript:;">' +data[i].ruleName + '</a>';
                    li.append(a).appendTo($('#leftUl'));
                }
                initLeftMenu(data);
            }
            //每次刷新处理 上方按钮
            dealwithToolbar(type);
        }
        //处理上添加按钮
        function dealwithToolbar(type){
            var add = $('#add');
            if(type=='KEYWORDS'){
                add.removeClass('hidden');
                add.removeClass('disabled').removeAttr('disabled');
            }else{
                add.addClass('hidden');
            }
        }
        //根据数据为右侧面板赋值
        function loadRightPanel(data){
            var list = data.weChatAutoResponseMsgTList[0];
            autoResponseId = data.autoResponseId;
            msgId = list.msgId;
            $('#ruleName').val(data.ruleName);
            $('#keyword').tagsinput('removeAll');
            if(data.keywords){
                data.keywords.split('\,').forEach(function (a) {
                    $('#keyword').tagsinput('add',a);
                })
                $('#keyword').next().next().addClass('pright');
            }
            var comp = DF.getComponent(cmtId);
            //初始化组件 为初始化状态
            comp && comp.clear && comp.clear()
            var compValue = list.msgType=='text'?list.content:list.mediaId;
            comp.setValue(compValue,list.msgType);
        }
        //清除右侧面板内容为空
        function clearRightPanel(){
            autoResponseId = '';
            msgId = '';
            $('#ruleName').val('');
            $('#keyword').tagsinput('removeAll');
            var comp = DF.getComponent(cmtId);
            comp.clear();
            tagsinputTriggerBindError(false);
        }
        //初始化左侧树
        function initLeftMenu(data){
            //注册 左侧点击事件
            tagsinputTriggerBindError(false);
            $('.list-unstyled.mailbox-list li').click(function (e) {
                var li = $(this);
                var id = li.attr('id');
                if(!li.hasClass('active')){
                    var liactive = $('.list-unstyled.mailbox-list li.active');
                    if(liactive.length && !liactive.attr('id')){
                        //dom删除
                        $('.list-unstyled.mailbox-list li.active').remove();
                        //清空面板
                        clearRightPanel();
                        dealwithToolbar('KEYWORDS');
                    };
                    $('.list-unstyled.mailbox-list li').removeClass('active');
                    li.addClass('active');
                    for(var i=0;i<data.length;i++) {
                        if(id == (data[i].autoResponseId)){
                            loadRightPanel(data[i]);
                            break;
                        }
                    };
                }
            }).first().trigger('click');
        }
        function initPage(){
            //点击页面确定加载 哪一个TAB
            $('.lymsg_tab a').click(function(){
                var $this = $(this);
                if(!$this.hasClass('active')){
                    $('.lymsg_tab a').removeClass('active');
                    !$this.hasClass('active') && $this.addClass('active');
                    toggleShowTab($this.index())
                }
            }).eq(0).trigger('click');

            $('#keyword').tagsinput({
                maxChars: 30,
                maxTags:10
            });
            $('.bootstrap-tagsinput input').focus(function () {
                $('.bootstrap-tagsinput').next().addClass('pright');
            });
            //删除 有数据提示 没有数据直接删除
            $('#delete').click(function () {
                //数据删除
                if(autoResponseId){
                    if(confirm('确定删除吗？')){
                        var $btn = $(this);
                        var current = $('#lymsg_tab_autoReply a.active');
                        var type = current.attr('type');
                        var url = 'weChatAutoResponseT/delAutoResponse/'+param.type+'/'+autoResponseId;
                        DF.ajax({
                            type: 'delete',
                            url: url,
                            success: function (data) {
                                loadTab($('#lymsg_tab_autoReply a.active').attr('type'));
                            }
                        });
                    };
                }else{
                    //dom删除
                    $('.list-unstyled.mailbox-list li.active').remove();
                    //清空面板
                    clearRightPanel()
                    //重新加载
                    loadTab($('#lymsg_tab_autoReply a.active').attr('type'));
                }
            });
            //保存
            $('#save').click(function () {
                var $btn = $(this);
                var current = $('#lymsg_tab_autoReply a.active');
                var type = current.attr('type');
                var index = current.index();
                //关键词回复
                if(index==2){
                    var valid = $('#autoReplyForm').valid();
                    tagsinputTriggerBindError(true);
                    if(!valid || !$('#keyword').val()){ return};
                    var comp = DF.getComponent(cmtId);
                    if(!comp.getValue()){DF.toast.warning('关键字回复不能为空');return }
                    var o = $('#autoReplyForm').serializeObject();
                    var msgType = comp.getType();
                    var data = {};
                    data.autoResponseId = autoResponseId;
                    data.responseType = type;
                    data.matchingType = 'LIKE';
                    data.keywords = o.keyword;
                    data.ruleName = o.ruleName;
                    data.weChatAutoResponseMsgTList = [{
                        autoResponseId:autoResponseId,
                        content:msgType=='text'?comp.getValue():"",
                        mediaId:msgType=='text'?"":comp.getValue()['media_id'],
                        msgType:msgType,
                        msgId:msgId
                    }];
                    var url = !autoResponseId?'weChatAutoResponseT/addAutoResponse/'+param.type: 'weChatAutoResponseT/editAutoResponse/'+param.type;
                    $btn.showLoading();
                    DF.ajax({
                        type: !autoResponseId?'post':'put',
                        url: url,
                        data:JSON.stringify(data),
                        success: function (data) {
                            $btn.hideLoading();
                            DF.toast.success(data.message);
                            loadTab($('#lymsg_tab_autoReply a.active').attr('type'));
                        }
                    });

                }else{
                    //前两种tab情况
                    var content = $('.lymsg_tab_body').eq(index).find('textarea').val();
                    if(!content){
                        DF.toast.warning('回复内容不能为空')
                        return
                    }
                    var data = {};
                    data.autoResponseId = autoResponseId;
                    data.responseType = type;
                    data.weChatAutoResponseMsgTList = [{
                        autoResponseId:autoResponseId,
                        content:content,
                        msgType:'text',
                        msgId:msgId
                    }];
                    var url = !autoResponseId?'weChatAutoResponseT/addAutoResponse/'+param.type: 'weChatAutoResponseT/editAutoResponse/'+param.type;
                    $btn.showLoading();
                    DF.ajax({
                        type: !autoResponseId?'post':'put',
                        url: url,
                        data:JSON.stringify(data),
                        success: function (data) {
                            $btn.hideLoading();
                            DF.toast.success(data.message);
                            loadTab($('#lymsg_tab_autoReply a.active').attr('type'));
                        }
                    });
                }
            });
            //添加按钮点击事件
            $('#add').click(function () {
                $('#leftUl li').removeClass('active');
                var li = $('<li class="active"><a href="javascript:;">'+'规则名称'+'</a></li>');
                $('#leftUl').append(li);
                clearRightPanel();
                $('#ruleName').focus().bind('input propertychange', function () {
                    li.find('a').text($(this).val());
                });
                $('#add').addClass('disabled').attr({
                    disabled: 'disabled'
                });
            });
        };
        function tagsinputTriggerBindError(flag){
            flag && $('#keyword').bind('input propertychange', function () {
                var v = $(this).val();
                var label = '<label id="keyword-error" class="error" for="keyword" style="display: inline-block;">必选字段</label>';
                if(v){
                    $(this).next().removeClass('error');
                    $('#keyword-error').remove();
                }else{
                    $(this).next().addClass('error');
                    $('#keyword-error').length==0  && $(this).next().after(label);
                    $('.bootstrap-tagsinput').next().addClass('pleft');
                }
            }).trigger('propertychange');
            if(!flag){
                $('#keyword').unbind('input propertychange');
                $('#keyword-error').prev().removeClass('error');
                $('#keyword-error').remove();
            }
        }
        initPage();
    })(jQuery);
</script>
