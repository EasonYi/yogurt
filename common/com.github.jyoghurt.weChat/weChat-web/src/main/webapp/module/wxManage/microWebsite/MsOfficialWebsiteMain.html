<!--&lt;!&ndash; Basic Setup Start&ndash;&gt;-->
<!--<div class="page-title">-->

    <!--<div class="title-env">-->
        <!--<h4 class="">微信消息管理</h4>-->
        <!--&lt;!&ndash;-->
       <!--<p class="description">应该说点什么编辑消息发送是不是呢</p>-->
       <!--&ndash;&gt;-->
    <!--</div>-->

    <!--<div class="breadcrumb-env">-->

        <!--<ol class="breadcrumb bc-1">-->
            <!--<li>-->
                <!--<a href="javascript:void(0)"><i class="fa-home"></i>微信管理</a>-->
            <!--</li>-->
            <!--<li>-->
                <!--<a href="javascript:void(0)">消息管理</a>-->
            <!--</li>-->
            <!--<li class="active">-->
                <!--<strong>新建消息</strong>-->
            <!--</li>-->
        <!--</ol>-->

    <!--</div>-->

<!--</div>-->
<div class="panel panel panel-default">
    <div class="panel-heading">
        <h4 class="panel-title lymsg_tab"><a id="pwmsg" class="active">新建微网站</a></h4>
        <div class="panel-options">
            <!--<span class="label-warning" style="padding: 5px;color: #fff;">菜单每次修改之后需要点击保存再生效哦</span>-->
            <button id="save" type="button" class="btn btn-success icon-right hidden">保存 <i class="fa fa-save"></i></button>
            <button id="back" type="button" class="btn btn btn-primary">返回</button>
        </div>
        <div class="panel-options" style="margin-right: 10px">
            <div class="alert alert-warning text-center " style="margin: 0;padding: 5px 10px;" id="">
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">×</span>
                    <span class="sr-only">Close</span>
                </button>
                <strong>注意!</strong>
                菜单每次修改之后需要点击保存再生效哦!
            </div>
        </div>
    </div>
    <div class="panel-body">
        <div class="row">
            <!-- 左边PANEL BEGIN -->
            <div class="col-sm-12 col-md-12" style="text-align: center" id="leftPanel">
                <div class="lymow left-view" style="">
                    <div id="phone" class="phone" style="margin: 75px 0px 90px 15px; padding: 0px; width: 305px; height: 427px; overflow-y: scroll; overflow-x: hidden;">
                        <!-- 模板加载位置 -->
                    </div>
                </div>
            </div>
            <!-- 左边PANEL END -->
            <!-- 右边PANEL BEGIN
             <i class="df_arrow arrow_out "></i>
                    <i class="df_arrow arrow_in"></i>
            -->
            <div class="col-sm-12 col-md-7 hidden" id="rightPanel">
                <form role="form" class="validate"  >
                    <div class="inner">

                        <div id="mwNameContainer" style="display: none;" class="mainContainer">
                            <div class="panel-heading" style="padding:10px 0;border-bottom: none;">
                                <div>微网站名称</div>
                            </div>
                            <div class="form-group ">
                                <label class="control-label" for="mwName">微网站名称</label>
                                <input type="text" class="form-control" id="mwName" name="mwName" required="true">
                            </div>
                        </div>


                        <div id="menuNameContainer" style="display: none;" class="mainContainer">
                            <div class="panel-heading" style="padding:10px 0;border-bottom: none;">
                                <div>菜单名称（最多4个字）</div>
                            </div>
                            <div class="form-group ">
                                <label class="control-label" for="menuName">菜单名称</label>
                                <input type="text" class="form-control" id="menuName" name="menuName" required="true" maxlength="4">
                            </div>
                        </div>

                        <div id="dropfileContainer" style="display: none;" class="mainContainer">
                            <div class="panel-heading" style="padding: 10px 0;border-bottom: none;">
                                <div>菜单图片</div>
                            </div>
                            <div id="dropfile" class="dropzone"></div>
                            <!-- 隐藏DIV 为formchange 服务 begin -->
                            <div class="form-group hidden">
                                <label></label>
                                <input type="hidden" id="dropfileHide">
                            </div>
                            <!-- end-->
                        </div>

                        <div class="form-group-separator"></div>

                        <div id="menuTypeContainer" style="display: none;" class="mainContainer">
                            <div class="">
                                <div class="panel-heading" style="padding:5px 0;border-bottom: none;">
                                    <div>菜单类型</div>
                                </div>
                            </div>
                            <p>
                                <label class="cbr-inline">
                                    <input id="menuRadio" type="radio" name="menuType" class="cbr cbr-secondary" value="1">
                                   二级菜单
                                </label>
                                <label class="cbr-inline">
                                    <input id="urlRadio" type="radio" name="menuType" class="cbr cbr-secondary" value="2">
                                   URL链接
                                </label>
                                <label class="cbr-inline">
                                    <input id="contentRadio" type="radio" name="menuType" class="cbr cbr-secondary" value="3">
                                    文本内容(注：所有图像宽度设为100%)
                                </label>
                            </p>

                            <div class="form-group mt" style="margin-top: 15px;">
                                <div class="panel-heading" style="padding:0;border-bottom: none;">
                                    <button id="menu" type="button" class="btn btn-success icon-right">点击编辑二级菜单<i class="linecons-search"></i></button>
                                </div>
                            </div>
                            <div class="form-group mt" style="margin-top: 15px;">
                                <div class="panel-heading" style="padding:0;border-bottom: none;">
                                    <label></label>
                                    <input id="url" type="text" name="value" class="form-control" url="true" required="true">
                                </div>
                            </div>
                            <div class="form-group mt" style="margin-top: 15px;">
                                <div class="panel-heading" style="padding:0;border-bottom: none;">
                                    <label></label>
                                    <div id="content" name="content" class="uEditor"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- 右边PANEL END -->
        </div>
    </div>
    <script>
        (function(){
            //上个页面传递的参数
            var param = DF.getUrlParam();
            //UE
            var editor = UE.getEditor('content');

            /**
             * 模板 选择器 设置
             * @type {{name: string, menuView: string, menuItem: string, menuItemImg: string, menuItemText: string}}
             * 名称、菜单整个DIV、菜单单个DIV、菜单图片、文字
             */
            var tmlConfigs = {
                'basic':{
                    main:{
                        name:'basic',
                        backgroundImg:'#websiteBGImg',
                        menuView:'.mune_67',
                        menuItem:'li.navs',
                        menuItemImg:'img',
                        menuItemText:'b'
                    },
                    second:{
                        name:'basic',
                        menuView:'.mod23',
                        menuItem:'div.telbtn_pc',
                        menuItemImg:'.pic_pc img',
                        menuItemText:'.t_t1_pc',
                        menuItemDesc:'.t_t2_pc'
                    }
                },
                'fresh':{
                    main:{
                        name:'fresh',
                        backgroundImg:'',
                        menuView:'.menu91',
                        menuItem:'a.nav',
                        menuItemImg:'img',
                        menuItemText:'span'
                    },
                    second:{
                        name:'fresh',
                        menuView:'.menu55',
                        menuItem:'a.nav',
                        menuItemImg:'.menu55_img img',
                        menuItemText:'.menu55_text b',
                        menuItemDesc:'.menu55_text span'
                    }
                }
            };
            //一级菜单数据
            var valueBox = {};
            //模板ID （有说明是新建）
            var tmlName = param.tmlName;
            //记录ID （有说明是编辑）
            var recordId = param.recordId;
            //服务号？订阅号
            var type = param.type;
            //菜单ID
            var menuId =param.menuId;
            //配置
            var config = tmlConfigs[tmlName]['main'];
            //监听是否变化
            var change = null;
            //新建
            if(tmlName){
                if(tmlConfigs[tmlName]){
                    DF.getPage('/wxManage/microWebsite/mwTmpl/'+tmlName+'/main',function(dom){
                        //加载模板
                        $('#phone').append(dom);
                        //修改
                        if(recordId){
                            DF.ajax({
                                url:'weChatWebsiteT/getMainWeb/'+recordId,
                                success:function(data){
                                    valueBox = data.result;
                                    initLeftPanel(valueBox);
                                    //初始化页面事件
                                    registPageEvent();
                                }
                            });
                        }else{
                            //持久化 数据
                            //根据模板内容 组织数据
//                            debugger;
                            var data = {list:[]};
                            var bg = $('#phone').find(config.backgroundImg);
                            var webImg = 'module/wxManage/microWebsite/mwTmpl/'+tmlName+'/img/bg_pc.jpg';
                            if(bg.length && bg[0].tagName=='DIV'){
                                webImg = bg.css('background');
                            }else if(bg.length && bg[0].tagName=='IMG'){
                                webImg = bg.attr('src');
                            }
                            var webName = '微官网';
                            var mouldId = tmlName;
                            data['webImg'] = webImg;
                            data['webName'] = webName;
                            data['mouldId'] = mouldId;
                            $(config.menuView).find(config.menuItem).each(function(){
                                var $this = $(this);
                                var obj = {};
                                obj.menuImg= $this.find(config.menuItemImg).attr('src');
                                obj.menuName = $this.find(config.menuItemText).text();
                                data.list.push(obj);
                            });
                            DF.ajax({
                                data:JSON.stringify(data),
                                url:'weChatWebsiteT/addWeb/'+type,
                                type:'post',
                                success:function(data){
                                    DF.toast.success(data.message);
                                    var webId = data.result;
                                    if(webId){
                                        DF.ajax({
                                            url:'weChatWebsiteT/getMainWeb/'+webId,
                                            success:function(data){
                                                valueBox = data.result;
                                                initLeftPanel(valueBox);
                                                //初始化页面事件
                                                registPageEvent();
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            }else{
                console.log('找不到该模板');
            }
            //注册事件 点击菜单右侧面板 显示隐藏
            function registPageEvent(){
                var menuDoms = $(config.menuView+' '+config.menuItem);
                menuDoms.each(function () {
                    var $this = $(this);
                    $this.click(function (e) {
                        if(change && change.isChange()){
                            DF.confirm('是否请保存页面！')
                            .done(function(){
                                $('#save').trigger('click');
                            }).fail(function(){
                                change = DF.on('formChange',$('#rightPanel form'));
                            });
                            e.preventDefault();
                            return
                        }
                        $('#save').removeClass('hidden');
                        $('#phone .active').removeClass('active');
                        $this.addClass('active');
                        if($('#rightPanel').hasClass('hidden')){
                            $('#leftPanel').addClass('col-md-5');
                            $('#rightPanel').removeClass('hidden');
                        }
                        if(!$('div.inner').hasClass('menu')){
                            $('.mainContainer').hide();
                            $('#menuNameContainer').fadeIn();
                            $('#dropfileContainer .panel-heading').text('菜单图片');
                            $('#dropfile').remove();
                            $('#dropfileContainer').append('<div id="dropfile" class="dropzone"></div>');
                            initDropfile('dropfile','menu');
                            $('#dropfileContainer').fadeIn();
                            $('#menuTypeContainer').fadeIn();
                        }
                        $('div.inner').addClass('menu');
                        initRightPanel($this);
                        change = DF.on('formChange',$('#rightPanel form'));
                    });
                    var domId = $this.attr('id');
                    if(domId){
                        //
                    }else{
                        console.error('模板需要设置ID');
                    }
                });
                //背景图片
                $(config.backgroundImg).click(function (e) {
                    if(change && change.isChange()){
                        DF.confirm('是否请保存页面！')
                                .done(function(){
                                    $('#save').trigger('click');
                                }).fail(function(){
                                    change = DF.on('formChange',$('#rightPanel form'));
                                });
                        e.preventDefault();
                        return
                    }
                    $('#save').removeClass('hidden');
                    if($('#rightPanel').hasClass('hidden')){
                        $('#leftPanel').addClass('col-md-5');
                        $('#rightPanel').removeClass('hidden');
                    }
                    $('.mainContainer').hide();
                    $('#mwNameContainer').fadeIn();
                    $('#dropfileContainer .panel-heading').text('主页背景照片');
                    $('#dropfile').remove();
                    $('#dropfileContainer').append('<div id="dropfile" class="dropzone"></div>');
                    initDropfile('dropfile','');
                    $('#dropfileContainer').fadeIn();
                    $('#phone .active').removeClass('active');
                    $(this).addClass('active');
                    //数据
                    var webImg = valueBox.webImg;
                    var webName = valueBox.webName;
                    $('#mwName').val(webName);
                    //图片
                    var dfDIV = '<div class="dz-preview dz-processing dz-success dz-image-preview">'+
                            '<div class="dz-details">'+
                            '<div class="dz-filename"><span data-dz-name=""></span></div>'+
                            '<div class="dz-size" data-dz-size=""><strong>0.0</strong> KiB</div>'+
                            '<img data-dz-thumbnail="" alt="" src="">'+
                            '</div>'+
                            '<div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress="" style="width: 100%;"></span></div>'+
                            '<div class="dz-success-mark"><span>✔</span></div>'+
                            '<div class="dz-error-mark"><span>✘</span></div>'+
                            '<div class="dz-error-message"><span data-dz-errormessage=""></span></div>'+
                            '<a class="dz-remove" href="javascript:undefined;" data-dz-remove="">删除</a>'+
                            '</div>';
                    var jqdf = $(dfDIV);
                    jqdf.find('.dz-remove').click(function () {
                        jqdf.remove();
                        $('#phone').find('img.active').attr('src','');
                        $('#dropfileHide').val('');
                        valueBox.webImg = '';
                    });
                    jqdf.find('img').attr('src',webImg);
                    $('#dropfileHide').val(webImg);
                    $('#dropfile').append(jqdf);
                    $('div.inner').removeClass('menu');
                    change = DF.on('formChange',$('#rightPanel form'));
                });
                //文件上传
                initDropfile('dropfile','menu');
                //redio
                cbr_replace();
                $('input[name=menuType]').change(function(){
                    var active = $('input[name=menuType]:checked');
                    var id = (active.attr('id'));
                    id = id.substr(0,id.indexOf('Radio'));
                    $('.mt').hide();
                    $('#'+id).parent().parent().fadeIn('250');
                });
                $('label.cbr-inline').first().trigger('click');
                //点击进入二级菜单编辑
                $('#menu').click(function (e) {
                    if(change && change.isChange()){
                        DF.confirm('是否请保存页面！')
                                .done(function(){
                                    $('#save').trigger('click');
                                }).fail(function(){
                                    change = DF.on('formChange',$('#rightPanel form'));
                                });
                        e.preventDefault();
                        return
                    }
                    var item = getActiveDom();
                    var menuId = item.attr('id');
                    var data = getActiveDataModel(menuId);
//                    if(data.clickType!=1){
//                        if(DF.confirm('是否保存当前页?')){
//                            //更新菜单
//                            data.clickType=1;
//                            DF.ajax({url:'weChatWebsiteMenuT',
//                                data:JSON.stringify(data),
//                                type:"put",
//                                success:function(data){
//                                    DF.toast.success(data.message);
//                                }
//                            });
//                        }else{
//                            return
//                        }
//                    }
                    var moduleId = valueBox.mouldId;
                    var webId = valueBox.webId;
                    //一级菜单ID 、记录ID、模板ID
                    DF.gotoPage('/wxManage/microWebsite/MsOfficialWebsiteSecond',{menuId:menuId,recordId:webId,tmlName:moduleId,type:type});
                });
                //默认选中菜单
                if(menuId){
                    $('#'+menuId).trigger('click');
                }
            }
            //获取当前选中菜单的数据值
            function getActiveDataModel(menuId){
                var data = valueBox.list;
                var result;
                if(data){
                    for(var k=0;k<data.length;k++){
                        if(data[k].menuId == menuId){
                            result =  data[k];
                            break;
                        }
                    }
                    return result;
                }
            }
            //获取当前选中的页面元素
            function getActiveDom(){
                return $('#phone .active');
            }
            //dropfile 添加
            function setActiveThumbImgSrc(url){
                if(!url){
                    return
                }
                //样式
                //alert($('#lymsgview .active img').css('width')+$('#lymsgview .active img').css('height'))
                var item = getActiveDom();
                item.find('img').attr('src',url).fadeIn(350);
                //数据
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.menuImg = url;
            }
            ////dropfile 删除
            function removeActiveThumbImgSrc(){
                var item = getActiveDom();
                item.find('img').attr('src','').fadeIn(350);
                //item.find('img').hide().prev().show();
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.menuImg = '';

            }
            //初始化 dropfile(1.菜单 2.背景)
            function initDropfile(selector,type){
                var config = {
                    url: "uploadImg/wx",
                    maxFiles: 1,
                    maxFilesize: 512,
                    addRemoveLinks:true,
                    dictRemoveFile:'删除',
                    dictMaxFilesExceeded:'只允许提交一个文件',
                    dictRemoveLinks: "loading",
                    dictCancelUpload: "上传中...",
                    dictDefaultMessage:'点击灰色区域上传图片',
                    dictResponseError:'上传失败，请确认图片服务器正常',
                    dictFallbackMessage:'您的浏览器不支持此插件',
                    acceptedFiles: ".png,.jpeg,.jpg",
                }
                //初始化菜单

                config.init =function() {
                    this.on("success", function(file,resp) {
                        if(resp.errorCode==1 && resp.result){
                            if($("#dropfile").find('.dz-preview').length==1){
                                var src = resp.result;
                                //为了onformchange
                                $('#dropfileHide').val(src);
                                if(type=='menu'){
                                    if(src){
                                        setActiveThumbImgSrc(src);
                                    }
                                }else{
                                    if(src){
                                        $('#phone').find('img.active').attr('src',src);
                                        valueBox.webImg = src;
                                    }
                                }
                            }
                        }
                    });
                    this.on("removedfile", function(file) {
                        if($("#dropfile").find('.dz-preview').length==0){
                            //为了onformchange
                            $('#dropfileHide').val('');
                            if(type=='menu'){
                                removeActiveThumbImgSrc();
                            }else{
                                $('#phone').find('img.active').attr('src','');
                                valueBox.webImg = '';
                            }
                        }
                    });
                }
                var dropFile = $("#"+selector).dropzone(config);
//                 var myDropzone = new Dropzone("div#"+selector, config);
            }
            //保存数据
            $('#save').click(function () {
                if(!DF.validate($('#rightPanel form'))) return;
                var $btn = $(this);
                $btn.showLoading();
                var flag = $('.inner.menu').length;
                //更新菜单
                if(flag){
                    var item = getActiveDom();
                    var menuId = item.attr('id');
                    var data = getActiveDataModel(menuId);
                    var clickType = $('input[name=menuType]:checked').val();
                    if(clickType==1){
                        data.clickType = 1;
                        data.text = '';
                        data.url = '';
                    }else if(clickType==2){
                        data.clickType = 2;
                        data.url = $('#url').val();
                        data.text = '';
                    }else{
                        data.clickType = 3;
                        data.text = editor.getContent();
                        data.url = '';
                    }
                    //更新菜单
                    DF.ajax({url:'weChatWebsiteMenuT',
                        data:JSON.stringify(data),
                        type:"put",
                        success:function(data){
                            DF.toast.success(data.message);
                            $btn.hideLoading();
                        }
                    });
                }else{
                    if(!valueBox.webImg){
                        DF.toast.warning('请上传背景图片');
                        $btn.hideLoading();
                        return
                    };
                    //更新网站主信息
                    DF.ajax({url:'weChatWebsiteT',
                        data:JSON.stringify(valueBox),
                        type:"put",
                        success:function(data){
                            DF.toast.success(data.message);
                            $btn.hideLoading();
                        }
                    });
                }
                change = DF.on('formChange',$('#rightPanel form'));
            });
            //返回
            $('#back').click(function () {
                DF.gotoPage('/wxManage/microWebsite/MicroWebsiteList?type='+type);
            });
            //右侧面板业务逻辑
            $('#mwName').blur(function () {
                valueBox.webName = $(this).val();
            });
            //菜单名
            $('#menuName').blur(function () {
                //数据
                var item = getActiveDom();
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.menuName = $(this).val();
                //DOM
                $(this).val() &&item.find(config.menuItemText).text($(this).val());
            });
            //右侧窗体赋值
            function initRightPanel($item){
                //取值
                var menuId = $item.attr('id');
                var data = getActiveDataModel(menuId);
                var src = data.menuImg;
                var menuName = data.menuName;
                var type = data.clickType;
                var url = data.url;
                var text = data.text;
                //赋值
                    //菜单名
                $('#menuName').val(menuName);
                    //图片
                if(src){
                    if($("#dropfile").find('.dz-preview').length==1){
                        //图片缩略图 预览路径
                        $('#dropfile').find('img').attr('src',src);
                    }else{
                        var dfDIV = '<div class="dz-preview dz-processing dz-success dz-image-preview">'+
                                '<div class="dz-details">'+
                                '<div class="dz-filename"><span data-dz-name=""></span></div>'+
                                '<div class="dz-size" data-dz-size=""><strong>0.0</strong> KiB</div>'+
                                '<img data-dz-thumbnail="" alt="" src="">'+
                                '</div>'+
                                '<div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress="" style="width: 100%;"></span></div>'+
                                '<div class="dz-success-mark"><span>✔</span></div>'+
                                '<div class="dz-error-mark"><span>✘</span></div>'+
                                '<div class="dz-error-message"><span data-dz-errormessage=""></span></div>'+
                                '<a class="dz-remove" href="javascript:undefined;" data-dz-remove="">删除</a>'+
                                '</div>';
                        var jqdf = $(dfDIV);
                        jqdf.find('.dz-remove').click(function () {
                            jqdf.remove();
                            removeActiveThumbImgSrc();
                            //为了formchange
                            $('#dropfileHide').val('');
                        });
                        jqdf.find('img').attr('src',src);
                        $('#dropfileHide').val(src);
                        $('#dropfile').append(jqdf);
                    }
                }else{
                    $("#dropfile").find('.dz-preview').length==1 && $("#dropfile").find('.dz-remove').trigger('click');
                }
                    //菜单类型
                $('label.cbr-inline').each(function(index){
                    if(type){
                        if((index+1)==type){
                            if(type==2){
                                $('#url').val(url);
//                                $('#content').val('');
                                editor.setContent('');
                            }
                            if(type==3){
//                                $('#content').val(text);
                                editor.setContent(text)
                                $('#url').val('');
                            }
                            $(this).trigger('click');
                        }
                    }else{
                        $('#url').val('');
//                        $('#content').val('');
                        editor.setContent('');
                        $('label.cbr-inline').first().trigger('click');
                    }
                });
            }
            //iphone内容 赋值
            function initLeftPanel(data){
                if(data){
                    $('#phone').find(config.backgroundImg).attr('src',data.webImg);
                    $(config.menuView).find(config.menuItem).each(function(index){
                        var $this = $(this);
                        var obj = data.list;
                        $this.attr('id',obj[index].menuId);
                        $this.find(config.menuItemText).text(obj[index].menuName);
                        $this.find(config.menuItemImg).attr('src',obj[index].menuImg);
                    });
                }
            }
            //判断表单内容是否变化
            function addListenerChange(){
                return true;
            }
        })(jQuery);
    </script>
</div>