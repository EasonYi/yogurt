<!--<div class="page-title">-->

    <!--<div class="title-env">-->
        <!--<h4 class="">微信消息管理</h4>-->
        <!--&lt;!&ndash;-->
       <!--<p class="description">应该说点什么编辑消息发送是不是呢</p>-->
       <!--&ndash;&gt;-->
    <!--</div>-->

    <!--<div class="breadcrumb-env">-->

        <!--<ol class="breadcrumb bc-1">-->
            <!--<li>-->
                <!--<a href="javascript:void(0)"><i class="fa-home"></i>微信管理</a>-->
            <!--</li>-->
            <!--<li>-->
                <!--<a href="javascript:void(0)">消息管理</a>-->
            <!--</li>-->
            <!--<li class="active">-->

                <!--<strong>消息列表</strong>-->
            <!--</li>-->
        <!--</ol>-->

    <!--</div>-->

<!--</div>-->
<!-- Basic Setup Start-->
<div class="panel panel-default">
    <div class="panel-heading">
        <h4 class="panel-title"> <a id="wmsg"> 微官网</a></h4>
        <div class="panel-options">
            <!--<a href="#" data-toggle="panel">-->
            <!--<span class="collapse-icon">&ndash;</span>-->
            <!--<span class="expand-icon">+</span>-->
            <!--</a>-->

            <!-- 关闭
                <a href="#" data-toggle="remove">
                &times;
            </a>
            <a href="#" data-toggle="reload">
                <i class="fa-rotate-right"></i>
            </a>
            -->
        </div>
    </div>
    <div class="panel-body">
        <!--<div class="row">-->
        <!--<div class="col-xs-6">-->
        <!--<div class="input-group width220">-->
        <!--<input type="text" class="form-control no-right-border form-focus-success">-->
        <!--<span class="input-group-btn">-->
        <!--<button class="btn btn-success" type="button">查询</button>-->
        <!--</span>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="col-xs-6" id="table_toolbar">-->
        <!--<button id="msg_create" type="button" class="btn btn-success pull-right icon-right">新建 <i class="fa fa-plus"></i></button>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="form-group-separator"></div>-->
        <div class="row">
            <table id="table" class="table  table-hover" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th>webId</th>
                    <th>微官网名称</th>
                    <th>缩略图</th>
                    <th>创建时间</th>
                    <th class="width130">操作</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script type="text/javascript">
        (function(){

            var param = DF.getUrlParam();
            var type = param.type;
            //删除 走后台
            function deleteRow(rowdata){
                DF.confirm('确认删除吗？').done(function(){
                    var id = rowdata.webId;
                    var url = 'weChatWebsiteT/'+id;
                    DF.ajax({
                        type:'delete',
                        url:url,
                    }).done(function(data,status){
                        reloadGrid();
                        DF.toast.success(data.message);
                    });
                })
            };
            //加载列表  走后台
            function reloadGrid(){
                grid.ajax.reload();
            };
            var previewbtn = {
                text:'预览',
                name:'preview',
                class:'btn-info',
                fn: function (rowdata) {
                    var webId = rowdata.webId;
                    var state = rowdata.state;
                    DF.ajax({
                        type:'post',
                        url:'weChatWebsiteT/creatHtml/'+webId,
                        success: function (data) {
                            //modal
                            var prevUrl = data.result;
                            var config = {
                                dom:$('#mw_tmpl_preview'),
                                title:'微官网预览',
                                btns:[]
                            };
                            config.btns.push({text:'二维码 ',
                                valid:false,
                                icon:'fa fa-qrcode',
                                class:'btn btn-primary',
                                fn:qrcodeHandler
                            } );
                            if(state==1){
                                config.btns.push({text:'复制当前页面URL ',
                                    valid:false,
                                    id:'copyBtn',
                                    icon:'fa fa-copy',
                                    class:'btn-info'
                                });
                            }
                            config.btns.push({text:'确定',
                                valid:false,
                                class:'btn-success',
                                fn:saveHandler
                            } );
                            function saveHandler(modal){
                                DF.hideModal(modal);
                            }
                            function qrcodeHandler(modal){
                                var iframe = document.getElementById('ifrm');
                                var url = iframe.contentWindow.location.href;
                                var left = $(this).position().left - 130;
                                var top = $(this).position().top - 60;
                                if($('#showqrcode').length==0){
                                    var tops = '<div class="popover fade left in" role="tooltip" id="showqrcode" style="top: '+top+'px; left: '+left+'px; display: block;">' +
                                            '<div class="arrow"></div><h3 class="popover-title">页面预览二维码</h3>' +
                                            '<div class="popover-content"><div id="output"></div></div>'+
                                            '</div>';
                                    modal.find('.modal-dialog').append(tops);
                                    $('#output').qrcode({width:100,height:100,correctLevel:0,text:url});
                                }else{
                                    $('#showqrcode').toggleClass('hidden');
                                }
                            }
                            DF.showModal(config, function (modal) {
                                var iframe = document.getElementById('ifrm');
                                iframe.src = prevUrl+'?_='+Math.random().toString().substring(2, 15);
                                iframe.onload = iframe.onreadystatechange = function() {
                                    if(iframe.contentDocument.readyState=='complete'){
//                                        modal.find('.btn-info').click(function () {
                                        $('#copyBtn').click(function () {
                                            $(this).zclip({
                                                path: "ZeroClipboard.swf",
                                                copy: function(){
                                                    return iframe.contentWindow.location.href;
                                                }
                                            });
                                        });
                                        //延时模拟点击一下
                                        setTimeout(function(){
                                            $('#copyBtn').trigger('click');
                                        },500);
                                    }
                                };
                                $('#showqrcode').length && $('#showqrcode').remove();
                            });
                        }
                    });
                }
            }
            var createbtn = {
                text:'生成',
                name:'publish',
                class:'btn-warning',
//                displayKey:'state',
//                displayValue:'0',
//                displayReg:function(rowdata){
//                    return rowdata.state == 0;
//                },
                fn: function (rowdata) {
                    var webId = rowdata.webId;
                    DF.ajax({
                        type:'post',
                        url:'weChatWebsiteT/publishHtml/'+webId,
                        success: function (data) {
                            DF.toast.success(data.message);
                            DF.reloadPage();
                        }
                    });
                }
            }

            var editbtn = {text:'编辑',name:'edit',class:'btn-success',fn:editRow};
            var deletebtn = {text:'删除',name:'delete',class:'btn-danger',fn:deleteRow };
            var grid = DF.dataTable({
                id:"table",
                ajax: "weChatWebsiteT/list/"+type,
                rowbtns:[createbtn,previewbtn,editbtn,deletebtn],
                toolbtns:[
                    {text:'新建',name:'create',class:'btn-success',icon:'fa fa-plus',fn:createRow}
                ],
                columns: [
                    { "data": "webId", "visible": false ,"orderable": false},
                    { "data": "webName" ,"orderable": false},
                    { "data": "webImg" ,"orderable": false},
                    { "data": "createDateTime" ,"orderable": false}
                ],
                columnDefs:[{
                    render: function(data, type, row) {
                        var dom = '<div class="innerbody">'+
                                '<div class="leftContent">'+
                                '<img style="width:96px;height:125px" src="'+data+'">'+
                                '<div class="sublist">'+
                                '</div>'+
                                '</div>'+
                                '</div>';

                        return dom;
                    },
                    "targets": 2
                }],
                //重新加载
                reloadGrid :reloadGrid,
                initComplete: function () {
                    $('table tbody tr').first().find('a.btn ').each(function (index) {
                        //data-intro="这是1" data-step="1"
                        var i = index + 1 ;
                        var btn = $(this);
                        btn.attr('data-step',i);
                        if(i==1){
                            btn.attr('data-intro','点击“生成”微官网地址才可以复制哦！');
                        }
                        if(i==2){
                            btn.attr('data-intro','“预览”分为电脑模拟预览与手机扫描二维码预览');
                        }
                        if(i==3){
                            btn.attr('data-intro','“编辑”后的模板必须点击“生成”才能生效哦！');
                        }
                        if(i==4){
                            btn.attr('data-intro','“删除”一条记录');
                        }

                    });
                    DF.initHelp();
                }
            });

            //修改
            function editRow(row){
                if(row.state==1){
//                    alert('已经‘生成’的数据无法编辑');
//                    return;
                }
                if(row.mouldId){
                    DF.gotoPage('/wxManage/microWebsite/MsOfficialWebsiteMain',{tmlName:row.mouldId,recordId:row.webId,type:type});
                }
            }
            //新建
            function createRow() {
                //modal
                var config = {
                    dom:$('#mw_tmpl_select'),
                    title:'模板选择',
                    width:'1000px',
                    btns:[{text:'确定',
                        valid:false,
                        icon:'btn-info',
                        fn:saveHandler
                    }]
                };
                function saveHandler(modal){
                    var form = modal.getForm();
                    var checked =$('.image-checkbox input:checked');
                    if(checked.length==1){
                        if(checked.val()){
                            DF.gotoPage('/wxManage/microWebsite/MsOfficialWebsiteMain',{tmlName:checked.val(),type:type});
                            DF.hideModal(modal);
                        }
                    }else{
                        alert('只能选择一个模板');
                    }
                }
                DF.showModal(config, function () {
                    cbr_replace();
                });
            }
            $('#showqrcode').length && $('#showqrcode').remove();
        })(jQuery);
    </script>
</div>
<!-- Basic Setup  End-->
<script type="text/template" id="mw_tmpl_select">
    <section class="gallery-env wxTmpl">
        <div class="row">

            <!-- Gallery Album Optipns and Images -->
            <div class="col-sm-12 gallery-right">

                <!-- Album Images -->
                <div class="album-images row">

                    <!-- Album Image -->
                    <div class="col-md-3 col-sm-4 col-xs-6">
                        <div class="album-image">
                            <a href="#" class="thumb" data-action="edit">
                                <img src="module/wxManage/microWebsite/mwTmpl/basic/img/basic.png" class="img-responsive" />
                            </a>

                            <a href="#" class="name">
                                <span>汽车模板</span>
                                <em>2015-10-09</em>
                            </a>

                            <div class="image-checkbox">
                                <input type="checkbox" class="cbr" value="basic" name="checkbox"/>
                            </div>
                        </div>
                    </div>
                    <!-- Album Image -->
                    <div class="col-md-3 col-sm-4 col-xs-6">
                        <div class="album-image">
                            <a href="#" class="thumb" data-action="edit">
                                <img src="module/wxManage/microWebsite/mwTmpl/fresh/img/fresh.png" class="img-responsive" />
                            </a>

                            <a href="#" class="name">
                                <span>清新模板</span>
                                <em>2015-11-25</em>
                            </a>

                            <div class="image-checkbox">
                                <input type="checkbox" class="cbr" value="fresh" name="checkbox"/>
                            </div>
                        </div>
                    </div>
                    <!-- Album Image -->
                    <!--<div class="col-md-3 col-sm-4 col-xs-6">-->
                        <!--<div class="album-image">-->
                            <!--<a href="#" class="thumb" data-action="edit">-->
                                <!--<img src="assets/images/album-img-4.png" class="img-responsive" />-->
                            <!--</a>-->

                            <!--<a href="#" class="name">-->
                                <!--<span>IMG_1008.jpg</span>-->
                                <!--<em>23 August 2014</em>-->
                            <!--</a>-->

                            <!--<div class="image-checkbox">-->
                                <!--<input type="checkbox" class="cbr" />-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--&lt;!&ndash; Album Image &ndash;&gt;-->
                    <!--<div class="col-md-3 col-sm-4 col-xs-6">-->
                        <!--<div class="album-image">-->
                            <!--<a href="#" class="thumb" data-action="edit">-->
                                <!--<img src="assets/images/album-img-4.png" class="img-responsive" />-->
                            <!--</a>-->

                            <!--<a href="#" class="name">-->
                                <!--<span>IMG_1008.jpg</span>-->
                                <!--<em>23 August 2014</em>-->
                            <!--</a>-->

                            <!--<div class="image-checkbox">-->
                                <!--<input type="checkbox" class="cbr" />-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                </div>

                <!--<button class="btn btn-white btn-block">-->
                    <!--<i class="fa-bars"></i>-->
                    <!--加载更多-->
                <!--</button>-->

            </div>
        </div>

    </section>
</script>

<script type="text/template" id="mw_tmpl_preview">
    <div class="row" style="text-align: center">
        <div class="lymow left-view" style="">
            <div id="phone" class="phone" style="margin: 75px 0px 90px 15px; padding: 0 15px 0 0;; width: 305px; height: 427px; overflow-y: hidden; overflow-x: hidden;">
                <iframe id="ifrm" src="" style="width: 100%;height: 100%;border: none;overflow: hidden" scrolling="yes"></iframe>
            </div>
        </div>
    </div>
</script>
