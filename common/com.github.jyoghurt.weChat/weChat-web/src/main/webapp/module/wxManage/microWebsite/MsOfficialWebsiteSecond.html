<!-- Basic Setup Start-->
<div class="page-title">

    <div class="title-env">
        <h4 class="">微信消息管理</h4>
        <!--
       <p class="description">应该说点什么编辑消息发送是不是呢</p>
       -->
    </div>

    <div class="breadcrumb-env">

        <ol class="breadcrumb bc-1">
            <li>
                <a href="javascript:void(0)"><i class="fa-home"></i>微信管理</a>
            </li>
            <li>
                <a href="javascript:void(0)">消息管理</a>
            </li>
            <li class="active">
                <strong>新建消息</strong>
            </li>
        </ol>

    </div>

</div>
<div class="panel panel panel-default">
    <div class="panel-heading">
        <h4 class="panel-title lymsg_tab"><a id="pwmsg" class="active">新建微网站</a></h4>
        <div class="panel-options">
            <button id="save" type="button" class="btn btn-success icon-right">保存 <i class="fa fa-save"></i></button>
            <button id="back" type="button" class="btn btn btn-primary">返回</button>
        </div>
        <div class="panel-options" style="margin-right: 10px">
            <div class="alert alert-warning text-center " style="margin: 0;padding: 5px 10px;" id="">
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">×</span>
                    <span class="sr-only">Close</span>
                </button>
                <strong>注意!</strong>
                菜单每次修改之后需要点击保存再生效哦!
            </div>
        </div>
    </div>
    <div class="panel-body">
        <div class="row">
            <!-- 左边PANEL BEGIN -->
            <div class="col-sm-12 col-md-12" style="text-align: center" id="leftPanel">
                <div class="lymow left-view" style="">
                    <div id="phone" class="phone" style="margin: 75px 0px 90px 15px; padding: 0px; width: 305px; height: 427px; overflow-y: scroll; overflow-x: hidden;">
                        <!-- 模板加载位置 -->
                    </div>
                </div>
            </div>
            <!-- 左边PANEL END -->
            <!-- 右边PANEL BEGIN
             <i class="df_arrow arrow_out "></i>
                    <i class="df_arrow arrow_in"></i>
            -->
            <div class="col-sm-12 col-md-7 hidden" id="rightPanel">
                <form role="form" class="validate"  >
                    <div class="inner">
                        <div class="panel-heading" style="padding:10px 0;border-bottom: none;">
                            <div>菜单名称（最多4个字）</div>
                        </div>
                        <div class="form-group" style="min-height: 0;margin-bottom: 0;">
                            <label class="control-label" for="menuName">菜单名称</label>
                            <input type="text" class="form-control" id="menuName" name="menuName" required="true" maxlength="4">
                        </div>

                        <div class="panel-heading" style="padding:10px 0;border-bottom: none;">
                            <div>菜单概要</div>
                        </div>
                        <div class="form-group" style="min-height: 0;margin-bottom: 0;">
                            <label class="control-label" for="menuDesc">菜单概要</label>
                            <input type="text" class="form-control" id="menuDesc" name="menuDesc"  required="true">
                        </div>

                        <div class="panel-heading" style="padding: 10px 0;border-bottom: none;">
                            <div>菜单图片</div>
                        </div>
                        <div id="dropfile" class="dropzone"></div>
                        <!-- 隐藏DIV 为formchange 服务 begin -->
                        <div class="form-group hidden">
                            <label></label>
                            <input type="hidden" id="dropfileHide">
                        </div>
                        <!-- end-->
                        <div class="form-group-separator" style="margin-bottom: 0;"></div>
                        <div class="">
                            <div class="panel-heading" style="padding:5px 0;border-bottom: none;">
                                <div>菜单类型</div>
                            </div>
                        </div>
                        <p>
                            <label class="cbr-inline">
                                <input id="urlRadio" type="radio" name="menuType" class="cbr cbr-secondary" value="2" >
                               URL链接
                            </label>
                            <label class="cbr-inline">
                                <input id="contentRadio" type="radio" name="menuType" class="cbr cbr-secondary" value="3">
                                文本内容(注：所有图像宽度设为100%)
                            </label>
                        </p>

                        <div class="form-group mt" style="margin-top: 15px;">
                            <div class="panel-heading" style="padding:0;border-bottom: none;">
                                <label></label>
                                <input id="url" type="text" name="value" class="form-control"  url="true" required="true">
                            </div>
                        </div>
                        <div class="form-group mt" style="margin-top: 15px;">
                            <div class="panel-heading" style="padding:0;border-bottom: none;">
                                <label></label>
                                <div id="content" name="content" class="uEditor"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- 右边PANEL END -->
        </div>
    </div>
    <script>
        (function(){
            //UE
            var editor = UE.getEditor('content');
            var tmlConfigs = {
                'basic':{
                    main:{
                        name:'basic',
                        menuView:'.mune_67',
                        menuItem:'li.navs',
                        menuItemImg:'img',
                        menuItemText:'b'
                    },
                    second:{
                        name:'basic',
                        menuView:'.mod23',
                        menuItem:'div.telbtn_pc',
                        menuItemImg:'.pic_pc img',
                        menuItemText:'.t_t1_pc',
                        menuItemDesc:'.t_t2_pc'
                    }
                },
                'fresh':{
                    main:{
                        name:'fresh',
                        backgroundImg:'',
                        menuView:'.menu91',
                        menuItem:'a.nav',
                        menuItemImg:'img',
                        menuItemText:'span'
                    },
                    second:{
                        name:'fresh',
                        menuView:'.menu55',
                        menuItem:'a.nav',
                        menuItemImg:'.menu55_img img',
                        menuItemText:'.menu55_text b',
                        menuItemDesc:'.menu55_text span'
                    }
                }
            };
            //一级菜单数据
            var valueBox = {};
            //获取当前选中菜单的数据值
            function getActiveDataModel(menuId){
                var data = valueBox;
                var result;
                if(data){
                    for(var k=0;k<data.length;k++){
                        if(data[k].menuId == menuId){
                            result =  data[k];
                            break;
                        }
                    }
                    return result;
                }
            }
            //上个页面传递的参数
            var param = DF.getUrlParam();
            //模板ID （有说明是新建）
            var tmlName = param.tmlName;
            //记录ID （有说明是编辑）
            var recordId = param.recordId;
            //菜单ID
            var menuId = param.menuId;
            //类型
            var type = param.type;
            //配置
            var config = tmlConfigs[tmlName]['second'];
            //监听是否变化
            var change = null;
            //新建
            DF.getPage('/wxManage/microWebsite/mwTmpl/'+tmlName+'/second',function(dom){
                    //加载模板
                    $('#phone').append(dom);
                    //查询二级菜单
                    DF.ajax({url:'weChatWebsiteMenuT/getList/'+menuId,
                        success:function(data){
                            if(!data.length){
                                //不存在获取二级菜单
                                var data = {list:[]};
                                data['webId'] = recordId;
                                $(config.menuView).find(config.menuItem).each(function(){
                                    var $this = $(this);
                                    var obj = {};
                                    obj.menuImg= $this.find(config.menuItemImg).attr('src');
                                    obj.menuName = $this.find(config.menuItemText).text();
                                    obj.resume = $this.find(config.menuItemDesc).text();
                                    data.list.push(obj);
                                });
                                //保存二级菜单
                                DF.ajax({
                                    url:'weChatWebsiteMenuT/addTwoMenu/'+menuId,
                                    type:'post',
                                    data:JSON.stringify(data),
                                    success:function(data){
                                        var menuId = data.result;
                                        //获取二级菜单
                                        DF.ajax({url:'weChatWebsiteMenuT/getList/'+menuId,
                                            success:function(data){
                                                valueBox = data;
                                                initLeftPanel(data);
                                                //初始化页面事件
                                                registPageEvent();
                                            }
                                        });
                                    }
                                });
                            //存在
                            }else{
                                valueBox = data;
                                initLeftPanel(data);
                                //初始化页面事件
                                registPageEvent();
                            }
                        }
                    });

            });


            /**
             * 模板数据对象
             * @type {{tmlName: string, title: string, imgSrc: string, menus: Array}}
             * 模板名称、网站的名称、首页的图片（就一个图片）、菜单
             */


            //注册事件
            function registPageEvent(){
                $(config.menuView+' '+config.menuItem).each(function () {
                    var $this = $(this);
                    $this.click(function (e) {
                        if(change && change.isChange()){
                            DF.confirm('是否请保存页面！')
                                    .done(function(){
                                        $('#save').trigger('click');
                                    }).fail(function(){
                                        change = DF.on('formChange',$('#rightPanel form'));
                                    });
                            e.preventDefault();
                            return
                        }
                        $(config.menuView+' '+config.menuItem).removeClass('active')
                        $this.addClass('active');
                        if($('#rightPanel').hasClass('hidden')){
                            $('#leftPanel').addClass('col-md-5');
                            $('#rightPanel').removeClass('hidden');
                        }
                        initRightPanel($this);
                        change = DF.on('formChange',$('#rightPanel form'));
                    });
                });


                //文件上传
                var dropFile = $("#dropfile").dropzone({
                    url: "uploadImg/wx",
                    maxFiles: 1,
                    maxFilesize: 512,
                    addRemoveLinks:true,
                    dictRemoveFile:'删除',
                    dictMaxFilesExceeded:'只允许提交一个文件',
                    acceptedFiles: ".png,.jpeg,.jpg",
                    init: function() {
                        this.on("success", function(file,resp) {
                            if(resp.errorCode==1 && resp.result){
                                if($("#dropfile").find('.dz-preview').length==1){
                                    //图片缩略图 预览路径
                                    var thumUrl = resp.result;
                                    if(thumUrl){
                                        setActiveThumbImgSrc(thumUrl);
                                        $('#dropfileHide').val(thumUrl);
                                    }
                                }
                            }
                        });
                        this.on("removedfile", function(file) {
                            if($("#dropfile").find('.dz-preview').length==0){
                                removeActiveThumbImgSrc();
                                $('#dropfileHide').val('');
                            }
                        });
                    }
                });
                //redio
                cbr_replace();
                $('input[name=menuType]').change(function(){
                    var active = $('input[name=menuType]:checked');
                    var id = (active.attr('id'));
                    id = id.substr(0,id.indexOf('Radio'));
                    $('.mt').hide();
                    $('#'+id).parent().parent().fadeIn('250');
                });
                $('label.cbr-inline').first().trigger('click');
                //二级菜单删除与增加
                $(config.menuItem).hover(function () {
                    var $this = $(this);
                    var menuId = $this.attr('id');
                    var data = getActiveDataModel(menuId);
                    var dom = '<div class="second_menu_option no-margin">' +
                                '<i class="fa fa-plus hover" title="添加" style="line-height: 20px;"></i>' +
                                '<i class="linecons-trash hover"title="删除" style="margin-left: 20px"></i>' +
                                '</div>';
                    var el = $(dom);
                    //添加
                    el.find('.fa-plus').click(function () {
                        var result ={};
                        var result = $.extend(result,data);
                        result.menuId = '';
                        DF.ajax({url:'weChatWebsiteMenuT',
                            data:JSON.stringify(result),
                            type:"post",
                            success:function(data){
                                var menuId = data.result;
                                result.menuId = menuId;
                                valueBox.push(result);
                                var element = $this.clone(true);
                                element.find('.second_menu_option').remove();
                                element.removeClass('active');
                                element.attr('id',menuId);
                                element.click(function () {
                                    $(config.menuView+' '+config.menuItem).removeClass('active');
                                    element.addClass('active');
                                    if($('#rightPanel').hasClass('hidden')){
                                        $('#leftPanel').addClass('col-md-5');
                                        $('#rightPanel').removeClass('hidden');
                                    }
                                    initRightPanel($this);
                                });
                                $this.parent().append(element);
                                DF.toast.success(data.message);
                            }
                        });
                    });
                    //删除
                    el.find('.linecons-trash').click(function () {
                        $this.fadeOut('fast', function () {
                            DF.ajax({url:'weChatWebsiteMenuT/'+menuId,
                                type:"delete",
                                success:function(data){
                                    DF.toast.success(data.message);
                                    $(config.menuItem).first().trigger('click');
                                    $this.remove();
                                }
                            });
                        })
                    });
                    $this.append(el);
                }, function () {
                    var $this = $(this);
                    $this.find('.second_menu_option').remove();
                });

            }
            //获取当前选中的页面元素
            function getActiveDom(){
                return $('#phone .active');
            }
            //dropfile 添加
            function setActiveThumbImgSrc(url){
                if(!url){
                    return
                }
                //样式
                //alert($('#lymsgview .active img').css('width')+$('#lymsgview .active img').css('height'))
                var item = getActiveDom();
                item.find(config.menuItemImg).attr('src',url).fadeIn(350);
                //数据
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.menuImg = url;
            }
            ////dropfile 删除
            function removeActiveThumbImgSrc(){
                var item = getActiveDom();
                item.find(config.menuItemImg).attr('src','').fadeIn(350);
                //item.find('img').hide().prev().show();
                //数据
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.menuImg = '';
            }
            //保存数据
            $('#save').click(function () {
                if(!DF.validate($('#rightPanel form'))) return;
                var item = getActiveDom();
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                var clickType = $('input[name=menuType]:checked').val();
                 if(clickType==2){
                    data.clickType = 2;
                    data.url = $('#url').val();
                    data.text = '';
                }else if(clickType==3){
                    data.clickType = 3;
                    data.text = editor.getContent();
                    data.url = '';
                }
                var $btn = $(this);
                $btn.showLoading();
                DF.ajax({url:'weChatWebsiteMenuT',
                    data:JSON.stringify(data),
                    type:"put",
                    success:function(data){
                        DF.toast.success(data.message);
                        $btn.hideLoading();
                    }
                });
                change = DF.on('formChange',$('#rightPanel form'));
            });
            //返回
            $('#back').click(function () {
                DF.gotoPage('/wxManage/microWebsite/MsOfficialWebsiteMain',{tmlName:tmlName,recordId:recordId,menuId:menuId,type:type});
            });
            //菜单名
            $('#menuName').blur(function () {
                //数据
                var item = getActiveDom();
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.menuName = $(this).val();
                //DOM
                $(this).val() &&item.find(config.menuItemText).text($(this).val());
            });
            //概要
            $('#menuDesc').blur(function () {
                //数据
                var item = getActiveDom();
                var menuId = item.attr('id');
                var data = getActiveDataModel(menuId);
                data.resume = $(this).val();
                //DOM
                $(this).val() &&item.find(config.menuItemDesc).text($(this).val());
            });
            //右侧窗体赋值
            function initRightPanel($item){
                //取值
                var menuId = $item.attr('id');
                var data = getActiveDataModel(menuId);
                var src = data.menuImg;
                var menuName = data.menuName;
                var menuDesc = data.resume;
                var type = data.clickType;
                var url = data.url;
                var text = data.text;
                //赋值
                $('#menuName').val(menuName);
                $('#menuDesc').val(menuDesc);
                if(src){
                    if($("#dropfile").find('.dz-preview').length==1){
                        //图片缩略图 预览路径
                        $('#dropfile').find('img').attr('src',src);
                    }else{
                        var dfDIV = '<div class="dz-preview dz-processing dz-success dz-image-preview">'+
                                '<div class="dz-details">'+
                                '<div class="dz-filename"><span data-dz-name=""></span></div>'+
                                '<div class="dz-size" data-dz-size=""><strong>0.0</strong> KiB</div>'+
                                '<img data-dz-thumbnail="" alt="" src="">'+
                                '</div>'+
                                '<div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress="" style="width: 100%;"></span></div>'+
                                '<div class="dz-success-mark"><span>✔</span></div>'+
                                '<div class="dz-error-mark"><span>✘</span></div>'+
                                '<div class="dz-error-message"><span data-dz-errormessage=""></span></div>'+
                                '<a class="dz-remove" href="javascript:undefined;" data-dz-remove="">删除</a>'+
                                '</div>';
                        var jqdf = $(dfDIV);
                        jqdf.find('.dz-remove').click(function () {
                            jqdf.remove();
                            removeActiveThumbImgSrc();
                            $('#dropfileHide').val('');
                        });
                        jqdf.find('img').attr('src',src);
                        $('#dropfile').append(jqdf);
                    }
                }else{
                    $("#dropfile").find('.dz-preview').length==1 && $("#dropfile").find('.dz-remove').trigger('click');
                }
                    //菜单类型
                $('label.cbr-inline').each(function(index){
                    if(type){
                        if((index+2)==type){
                            if(type==2){
                                $('#url').val(url);
                                editor.setContent('');
                            }
                            if(type==3){
                                editor.setContent(text)
                                $('#url').val('');
                            }
                            $(this).trigger('click');
                        }
                    }else{
                        $('#url').val('');
                        editor.setContent('')
                        $('label.cbr-inline').first().trigger('click');
                    }
                });

            }
            //iphone内容 赋值 根据 数据库数据 根据模板第一条内容 遍历
            function initLeftPanel(data){
                if(data){
                    var dom = $(config.menuView).find(config.menuItem).first();
                    var container = dom.parent();
                    container.children().remove();
                    for(var k=0;k<data.length;k++){
                        var element = dom.clone();
                        element.attr('id',data[k].menuId);
                        element.find(config.menuItemText).text(data[k].menuName);
                        element.find(config.menuItemDesc).text(data[k].resume);
                        element.find(config.menuItemImg).attr('src',data[k].menuImg);
                        container.append(element);
                    }
//                    $(config.menuView).find(config.menuItem).each(function(index){
//                        var $this = $(this);
//                        var obj = data;
//                        $this.attr('id',obj[index].menuId);
//                        $this.find(config.menuItemText).text(obj[index].menuName);
//                        $this.find(config.menuItemDesc).text(obj[index].resume);
//                        $this.find(config.menuItemImg).attr('src',obj[index].menuImg);
//                    });
                }
            }

        })(jQuery);
    </script>
</div>