<!-- Basic Setup Start-->
<div class="page-container">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">字典管理-数据项</h3>

        </div>
        <div class="page-container">

            <div class="row">
                <div class="col-sm-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <table id="table" class="table  table-bordered table-hover" cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th>id</th>
                                    <th>字典项编码</th>
                                    <th>字典项名称</th>
                                    <th>描述</th>
                                    <th>父枚举项id</th>
                                    <th>父字典项名称</th>
                                    <th>是否支持界面配置</th>
                                    <th class="width130">操作</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>




            <script type="text/javascript">
                (function ($) {

                    var cmtId;

                    /**
                     *编辑或者新建 逻辑判断 无后台
                     * rowdata 行数据
                     */
                    function editRow(rowdata) {

                        //编辑还是保存
                        var flag = rowdata ? true : false;
                        //弹出菜单的业务逻辑方法
                        function saveHandler(modal) {
                            saveOrUPdate(modal, flag, function (data, status) {

                                if(data.result == '1'){
                                    //提示有重复
                                    DF.toast.error("字典项编码重复");
                                    //清空数据
                                    $("#dictItemCode").val("");
                                    //设置焦点
                                    $("#dictItemCode").focus();
                                    return;
                                }

                                DF.toast.success(data.message);
                                DF.hideModal(modal);
                                reloadGrid();
                            });
                        }

                        //modal窗口的配置项目
                        var config = {
                            dom: $('#dataDictItemForm'),
                            title: flag ? '编辑页面' : '新建页面',
                            btns: [{
                                text: '保存',
                                icon: 'btn-info',
                                fn: saveHandler
                            }]
                        };
                        DF.showModal(config, function (modal) {
                            /*回调函数中的参数
                             * modal为当前的模块窗口 其中提供 getForm()方法 返回 业务的form 此form为 jq对象
                             */
                            flag && loadForm(modal, rowdata);
                        });
                    };
                    //删除 走后台
                    function deleteRow(rowdata) {
                        if (confirm('确认删除吗？')) {
                            var url = 'dataDict/' + rowdata.dictItemId;
                            var sfn = function (data, status) {
                                reloadGrid();
                                DF.toast.success(data.message);
                            };
                            DF.ajax({
                                type: 'delete',
                                url: url,
                                success: sfn
                            });
                        }
                    };
                    //加载列表  走后台
                    function reloadGrid() {
                        grid.ajax.reload();
                    };
                    //加载表单  如果rowdata 数据满足  可以直接赋值 不用走后台
                    function loadForm(modal, rowdata) {
                        var form = modal.getForm();
                        if (rowdata) {
                            DF.setFormValues(rowdata, form);
                        }
                    };

                    //检查DictItemCode是否有重复
                    function checkItemCodeDulp(data){
                        var result;
                        if(!(data.dictItemCode)){
                            return false;
                        }

                        var sfn = function (data, status) {
                            result = data.result;
                        };
                        DF.ajax({
                            data: JSON.stringify(data),
                            type: 'PUT',
                            url: "dataDict/checkItemCodeDulp",
                            async: false,
                            dataType: 'json',
                            success: sfn
                        });

                        if(result=='0'){
                            return false;
                        }
                        return true;
                    }

                    //保存表单or编辑表单  走后台
                    function saveOrUPdate(modal, flag, fn) {
                        var form = modal.getForm();
                        var data = form.serializeObject();
                        if(!checkItemCodeDulp(data)){

                            var sfn = function (data, status) {
                                fn && fn(data, status);
                            };
                            DF.ajax({
                                data: JSON.stringify(data),
                                type: flag ? 'PUT' : 'POST',
                                url: "dataDict",
                                dataType: 'json',
                                success: sfn
                            });
                        }else{
                            //提示有重复
                            DF.toast.error("字典项编码重复");
                            //清空数据
                            $("#dictItemCode").val("");
                            //设置焦点
                            $("#dictItemCode").focus();
                        }

                    };
                    var grid = DF.dataTable({
                        id: "table",
                        ajax: "dataDict/list",
                        rowbtns: [
                            {text: '编辑', name: 'edit', class: 'btn-success', fn: editRow},
                            {text: '删除', name: 'delete', class: 'btn-danger', fn: deleteRow}
                        ],
                        toolbtns: [
                            {text: '新建', name: 'create', class: 'btn-success', icon: 'fa fa-plus', fn: editRow},
                        ],
                        columns: [
                            {"data": "dictItemId", "orderable": false, "visible": false},
                            {"data": "dictItemCode", "orderable": false, "width": "25%"},
                            {"data": "dictItemName", "orderable": false, "width": "25%"},
                            {"data": "dicItemDesc", "orderable": false, "width": "25%"},
                            {"data": "parentDictItemCode", "orderable": false, "visible": false},
                            {"data": "parentDictItemName", "orderable": false, "width": "25%"},
                            {"data": "uiConfigurable", "orderable": false, "visible": false}
                        ],
                        columnDefs: [{
                            render: function (data, type, row) {
                                return data;
                            },
                            "targets": 2
                        }],
                        createdRow: function (row, data, index) {
                            $('td', row).click(function () {
                                $("#dataValueContent").removeClass("hidden");
                                var dataDictValueObj = DF.getComponent(cmtId);
                                dataDictValueObj.initPanel(data);
                            })
                        },
                        //表单详情
                        viewForm: {dom:$('#dataDictItemForm'),title:'数据项详情',width:'1000px'},
                        //新建行函数
                        createItem: editRow,
                        //编辑函数
                        editItem: editRow,
                        //删除函数
                        deleteItem: deleteRow,
                        //重新加载
                        reloadGrid: reloadGrid,
                        //初始化结束后回调
                        initComplete: function () {
                            cmtId = DF.create({codes:{single:1},id: 'dataDictValue_component_layOut'},
                                    $("#dataDictValue"));
                        }
                    });
                })(jQuery);


            </script>
        </div>
    </div>
</div>
<div class="page-container">
    <div class="panel panel-default hidden" id="dataValueContent">
        <div class="panel-heading">
            <h3 class="panel-title">数据值</h3>

        </div>
        <div class="page-container">
            <div class="row">
                <div class="col-sm-12">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div class="col-md-12" id="dataDictContent">
                                <div class="form-group">
                                    <label class="control-label"></label>

                                    <div id="dataDictValue"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 字典项表单-->
<script type="text/template" id="dataDictItemForm">
    <form class="validate">
        <div class="row">
            <div class="col-md-12">
                <div class="form-group hidden">
                    <label class="control-label"></label>
                    <input type="text" name="dictItemId">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="dictItemCode" class="control-label">字典项编码</label>
                    <input type="text" name="dictItemCode" class="form-control" id="dictItemCode"
                           placeholder="" required maxlength="40">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="dictItemName" class="control-label">字典项名称</label>
                    <input type="text" name="dictItemName" class="form-control" id="dictItemName"
                           placeholder="" required maxlength="40">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="dicItemDesc" class="control-label">描述</label>
                    <input type="text" name="dicItemDesc" class="form-control" id="dicItemDesc"
                           placeholder="" maxlength="100">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="parentDictItemCode" class="control-label">父字典项名称</label>
                    <select id="parentDictItemCode" dataurl="dataDict/getDataDictValuesByItemCode" key="dictItemCode"
                            parseValue="dictItemName" autoload="true" name="parentDictItemCode" class="form-control">
                        <option></option>
                    </select>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="uiConfigurable" class="control-label">是否支持界面配置</label>
                    <select id="uiConfigurable" name="uiConfigurable" required="true" class="form-control">
                        <option value="true">是</option>
                        <option value="false">否</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="uiConfigurable" class="control-label">是否单独显示</label>
                    <select id="singleFlag" name="singleFlag" required="true" class="form-control">
                        <option value="0">是</option>
                        <option value="1">否</option>
                    </select>
                </div>
            </div>
        </div>
    </form>
</script>


