<div class="dictWrapper">
    <div class="row">
        <!--通讯录树-->
        <div class="col-sm-4">
            <div class="panel panel-default" style="height: 397px;">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a href="javascript:;">数据字典树</a>
                    </h3>
                </div>
                <div class="DFTree panel-body">
                    <!--<div class="input-group input-group-minimal">-->
                        <!--<input type="text" id="dataItemSearchInputVal" class="form-control">-->
                        <!--<div class="input-group-addon" id="dataItemSearchInput">-->
                            <!--<a href="javascript:;" ><i class="linecons-search"></i></a>-->
                        <!--</div>-->
                    <!--</div>-->
                    <ul id="treeDemo" class="ztree" style="margin-top: 15px;padding: 0 20px;height: 250px;overflow-y: auto;"></ul>
                </div>
            </div>
        </div>
        <!--右侧内容展现区-->
        <div class="col-sm-8">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a href="javascript:;">字典项详情</a>
                    </h3>
                </div>
                <div class="panel-body">
                    <form class="validate" id="dictForm">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin">
                                    <label for="parentDictItemName" class="control-label">父字典项名称</label>
                                    <input type="text" name="parentDictItemName" class="form-control"
                                           id="parentDictItemName"
                                           placeholder="" maxlength="36" readonly="readonly">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin hidden">
                                    <label for="parentDictItemCode" class="control-label">父字典项id</label>
                                    <input type="text" name="parentDictItemCode" class="form-control"
                                           id="parentDictItemCode"
                                           placeholder="" maxlength="36">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin" hidden>
                                    <label for="dictItemId" class="control-label">字典项id</label>
                                    <input type="hidden" name="dictItemId" class="form-control" id="dictItemId">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin">
                                    <label for="dictItemCode" class="control-label">字典项编码</label>
                                    <input type="text" name="dictItemCode" class="form-control readOnlyField"
                                           id="dictItemCode"
                                           placeholder="" required maxlength="40">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin">
                                    <label for="dictItemName" class="control-label">字典项名称</label>
                                    <input type="text" name="dictItemName" class="form-control readOnlyField"
                                           id="dictItemName"
                                           placeholder="" required maxlength="40">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin">
                                    <label for="sortNum" class="control-label">排序</label>
                                    <input type="text" name="sortNum" class="form-control readOnlyField" id="sortNum"
                                           placeholder="" range="[1,999]" maxlength="3">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin">
                                    <label for="dictItemDesc" class="control-label">描述</label>
                                    <input type="text" name="dicItemDesc" class="form-control readOnlyField"
                                           id="dictItemDesc"
                                           placeholder="" maxlength="100">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <button id="dictItemSubmit" type="button" class="btn btn-info displayBtn">保存 <i
                                        class="fa fa-save"></i></button>
                                <button id="dictSubAdd" type="button" class="btn btn-info ">添加子节点 <i
                                        class="fa fa-angle-right"></i></button>
                                <button id="loadDictValue" type="button" class="btn btn-info displayBtn">加载字典值 <i
                                        class="fa fa-list-ul"></i></button>

                                <button id="dictValueAdd" type="button" class="btn btn-info displayBtn">新建字典值 <i
                                        class="fa fa-angle-right"></i></button>

                                <button id="delDictItem" type="button" class="btn btn-danger pull-right displayBtn">
                                    删除字典项 <i class="fa fa-trash"></i></button>
                                <div class="form-group no-margin pull-right displayBtn" style="line-height: 40px;">
                                    <label class="control-label" for="autoLoadDictValue"
                                           style="color:#999 !important;display: inline !important;">自动加载字典值</label>
                                    <input type="checkbox" class="iswitch iswitch-secondary no-placeholder"
                                           id="autoLoadDictValue" name="autoLoadDictValue">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-sm-12">
            <div class="panel panel-default hidden">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a href="javascript:;">字典值树</a>
                    </h3>
                </div>
                <div class="panel-body" id="dictValueCmt">

                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    (function ($) {
        var $form = $('#dictForm');
        var currentNode = null;
        var cmtId = null;
        var param = DF.getUrlParam();
        var dataDictItemCode = '';
        param && param.dataDictItemCode && (dataDictItemCode = param.dataDictItemCode);
        var root = {
            id: '666',
            text: '数据字典项',
            dictItemId: '',
            "isParent": true,
            dictItemCode: '',
            dictItemName: '数据字典项',
            parentDictItemName: '无',
            open: true
        };


        dictCodeTree = DF.zTree({
            id: 'treeDemo',
            url: 'dataDict/getSubDataDictTree?dataDictItemCode=' + dataDictItemCode,
            checkable: false,
            dragable: true,
//            root: root,
            idKey: 'dictItemCode',
            textKey: 'dictItemName',
            pidKey: 'parentDictItemCode',
//            autoParam:'',
            callback: {
                onClick: function (event, treeId, treeNode) {
                    console.log(treeNode);
                    //detroyMenuContext();
                    if (treeNode.getParentNode()) {
                        treeNode.parentDictItemName = treeNode.getParentNode().dictItemName;
                    }
                    //$form.reset();
                    DF.setFormValues(treeNode, $form);
                    currentNode = treeNode;
                    //如果自动加载字典值
                    displayOrShow();
                },
                //右键
//                onRightClick:function(event, treeId, treeNode){
//                    event.preventDefault();
//                    if(dictCodeTree.getSelectedNodes().length){
//                        var top = event.target.offsetTop+'px;';
//                        var itemObj = {
//                            sameLevel:'添加同级',
//                            subLevel:'添加下级',
//                            lStyle:'position: absolute;top:'+ top +'left: 128px;',
//                            aStyle:'max-height: 35px;line-height: 10px;width: 100px;'
//                        };
//                        var contextMenu = '<div class="list-group list-group-minimal" style="{{lStyle}}">' +
//                                '<a href="#" class="list-group-item" name="sameLevel" style="{{aStyle}}">{{sameLevel}}</a>' +
//                                '<a href="#" class="list-group-item" name="subLevel" style="{{aStyle}}">{{subLevel}}</a></div>'+
//                                '</div>';
//                        detroyMenuContext();
//                        $('.DFTree').append(DF.template(contextMenu,itemObj));
//                        console.log(event,event.target.offsetTop)
//                    }
//                },
                onAsyncSuccess: function (event, treeId, treeNode, msg) {
                    clickTreeFirstNode();
//                    console.log(treeNode,msg);
                }
            },
            onComplete: function (treeObject) {
                cmtId = DF.create({codes: {}, id: 'dataDictValue_component_layOut'}, $("#dictValueCmt"));
                clickTreeFirstNode();
            }
        });

        /**
         * 创建面板
         */
        function createPanel() {

        }

//        function detroyMenuContext(){
//            $('.list-group').remove();
//        }

        /**
         * 加载字典列表
         */
        function loadDictValueGrid(node) {
            $("#dictValueCmt").parent().removeClass("hidden");
            var dataDictValueObj = DF.getComponent(cmtId);
            dataDictValueObj.initPanel(node);
        }

        /**
         * 点击树的第一个节点
         */
        function clickTreeFirstNode() {
            $('#' + dictCodeTree.getNodes()[0].tId + '_a').trigger('click');
        }
        //保存字典项
        $('#dictItemSubmit').click(function () {
            var btn = $(this);
            if (DF.validate($form)) {
                var postData = $form.serializeObject();
                var isAdd = postData.dictItemId ? false : true;
                btn.showLoading();
                DF.ajax({
                    url: isAdd ? 'dataDict/addDataDictItem' : 'dataDict/updateDataDictItem',
                    data: JSON.stringify(postData),
                    type: isAdd ? 'POST' : 'PUT'
                }).done(function (resp) {
                    if (resp.errorCode == 1) {
                        DF.toast.success(resp.message);
                    } else if (resp.errorCode == 9001) {
                        DF.toast.error(resp.message)
                    }
                    reloadTree();
                    btn.hideLoading();
                });
                console.log($form.serializeObject());
            }
        });
        //添加子字典项
        $('#dictSubAdd').click(function () {
            if (dictCodeTree.getSelectedNodes().length) {
                $('.parentDict').removeClass('hidden');
                var subNode = {
                    parentDictItemCode: currentNode.id,
                    parentDictItemName: currentNode.dictItemName,
                    dictItemCode: "",
                    dicItemDesc: "",
                    dictItemId: "",
                    dictItemName: ""
                };
                DF.setFormValues(subNode, $form);
                DF.initCustomFormPlaceHolder($form);
                displayOrShow(true);

            } else {
                DF.toast.warning('请选择一个节点!');
            }
        });
        //加载某字典项下的字典值
        $('#loadDictValue').click(function () {
            loadDictValueGrid(currentNode);
        });

        $('#dictValueAdd').click(function () {
            console.log("dictValueAdd");
            $("#dictValueCmt").parent().removeClass("hidden");
            var dataDictValueObj = DF.getComponent(cmtId);
            dataDictValueObj.initPanel(currentNode, true);
        });


        //删除字典项
        $('#delDictItem').click(function () {
            DF.confirm('确认删除此字典项？').done(function () {
                if (currentNode.id === '') {
                    DF.toast.error('根节点无法删除!');
                    return
                }
                var sfn = function (data, status) {
                    DF.toast.success(data.message);
                    reloadTree();
                };
                DF.ajax({
                    url: 'dataDict/' + currentNode.dictItemCode,
                    type: 'DELETE',
                    success: sfn
                });
            });
        });
        //显示隐藏 按钮 panel
        function displayOrShow(flag) {
            if (currentNode.id == -1 && !flag) {
                $('.displayBtn').addClass('hidden');
                $('.readOnlyField').attr('readonly', 'readonly');
            } else {
                $('.displayBtn').removeClass('hidden');
                $('.readOnlyField').removeAttr('readonly');
            }
            if (!!$('#autoLoadDictValue:checked').length) {
                $('#loadDictValue').trigger('click');
            } else {
                $("#dictValueCmt").parent().addClass("hidden");
            }
        }

        //重新加载树
        function reloadTree() {
//            dictCodeTree.reAsyncChildNodes(currentNode,'refresh');
            dictCodeTree.reAsyncChildNodes(dictCodeTree.getNodesByParam("id", '', null)[0], 'refresh');
        }

    })(jQuery)
</script>