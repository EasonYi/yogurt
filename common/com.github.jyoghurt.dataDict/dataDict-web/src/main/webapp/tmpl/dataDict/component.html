<script type="text/html" id="dataDictValue_component_layOut">
    <div id="{{id}}">
        <div class="row">
            <!--通讯录树-->
            <div class="col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <a href="javascript:;">数据字典值树</a>
                        </h3>
                    </div>
                    <div class="DFTree panel-body">
                        <ul id="dictValueTree" class="ztree"
                            style="margin-top: 15px;padding: 0 20px;height: 400px;overflow-y: auto;"></ul>
                    </div>
                    <!--<div class="panel-disabled"><div class="loader-2"></div></div>-->
                </div>
            </div>
            <!--右侧内容展现区-->
            <div class="col-sm-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <a href="javascript:;">字典值详情</a>
                        </h3>
                    </div>
                    <div class="panel-body">
                        <form class="validate" id="dictValueForm">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="parentDictItemCode1" class="control-label">字典项编码</label>
                                        <input type="text" name="parentDictItemCode" class="form-control"
                                               id="parentDictItemCode1"
                                               placeholder="" maxlength="40" readonly="readonly">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="parentDictValueCode" class="control-label">父字典值编码</label>
                                        <input type="text" class="form-control" id="parentDictValueCode"
                                               name="parentDictValueCode"
                                               placeholder="" maxlength="36" readonly="readonly">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="parentDictValueName" class="control-label">父字典值名称</label>
                                        <input type="text" class="form-control" id="parentDictValueName"
                                               name="parentDictValueName"
                                               placeholder="" maxlength="36" readonly="readonly">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin" hidden>
                                        <label for="dictValueId" class="control-label">字典项id</label>
                                        <input type="hidden" name="dictValueId" class="form-control" id="dictValueId">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="dictValueName" class="control-label">字典值名称</label>
                                        <input type="text" name="dictValueName" class="form-control readOnlyField"
                                               id="dictValueName"
                                               placeholder="" required maxlength="40">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="dictValueCode" class="control-label">字典值</label>
                                        <input type="text" name="dictValueCode" class="form-control readOnlyField"
                                               id="dictValueCode"
                                               placeholder="" required maxlength="40">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="sortNum" class="control-label">排序</label>
                                        <input type="text" name="sortNum" class="form-control readOnlyField"
                                               id="sortNum" placeholder="" range="[1,999]" maxlength="3">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group no-margin">
                                        <label for="dictValueDesc" class="control-label">描述</label>
                                        <input type="text" name="dictValueDesc" class="form-control readOnlyField"
                                               id="dictValueDesc"
                                               placeholder="" maxlength="100">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <button id="dictValueSubmit" type="button" class="btn btn-info displayBtn">保存 <i
                                            class="fa fa-save"></i></button>
                                    <button id="dictValueSubAdd" type="button" class="btn btn-info ">添加子节点 <i
                                            class="fa fa-angle-right"></i></button>
                                    <button id="dictValueSameLevelAdd" type="button" class="btn btn-info ">添加同级节点 <i
                                            class="fa fa-angle-right"></i></button>
                                    <button id="delDictValue" type="button"
                                            class="btn btn-danger pull-right displayBtn">删除字典值 <i
                                            class="fa fa-trash"></i></button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        <![CDATA[
        (function ($) {
            var selector = '{{id}}';
            var single = '{{single}}';
            console.log("selector:" + selector);
            console.log("single:" + single);
            var param = DF.getUrlParam();
            console.log(param);

            var $form = $('#dictValueForm');
            var currentNode = null;
            window.dictValueTree = null;
            //输出
            var exports = {};
            //点击第一个节点
            function clickTreeFirstNode(tree) {
                console.log(".....................");
                var nodes = dictValueTree.getSelectedNodes();
                if (nodes.length == 0) {
                    $('#' + tree.getNodes()[0].tId + '_a').trigger('click');
                }
            }

            function clickTreeSelectNode(dictValueTree) {
                var nodes = dictValueTree.getSelectedNodes();
                if (nodes.length == 0) {
                    dictValueTree.selectNode(nodes[0]);
                }
            }

            //重新加载树
            function reloadTree(dictValueTree) {
                exports.initPanel(d);
                //debugger;
//                var nodes = dictValueTree.getNodes();
//                if (nodes.length > 0) {
//                    dictValueTree.reAsyncChildNodes(dictValueTree.getNodes()[0], "refresh");
//                }
            }


            var d;

            function addDataDictValue() {
                console.log("55");
                var subNode = {
                    dictValueId: "",
                    dictItemCode: "",
                    dictValueCode: "",
                    dictValueName: "",
                    dictValueDesc: "",
                    parentDictValueCode: "",
                    parentDictValueName: "",
                    sortNum: ""
                };
                DF.setFormValues(subNode, $form);
                DF.initCustomFormPlaceHolder($form);
            }

            //初始化面板
            exports.initPanel = function (data, addDataDictValueFlag) {
                d = data;
                DF.initCustomFormPlaceHolder($form);
                $form.reset();
                $('#parentDictItemCode1').val(d.dictItemCode);

                $('#delDictValue').addClass('disabled').attr({
                    disabled: 'disabled'
                });

                var urlHome = 'dataDict/dataDictValue/tree';
                var url = urlHome;
                var dictItemCode = d.dictItemCode;

                dictValueTree = DF.dataDictTree({
                    id: 'dictValueTree',
                    //dictItemCode: 'AutoMaker',
                    //levelDictItemCode : 'AutoSeries,AutoType',
                    //cascadeParentName :true,
                    dictItemCode: dictItemCode,
                    url: url,
                    checkable: false,
                    searchable: false,
                    dragable: false,
                    idKey: 'treeNodeStr',
                    textKey: 'dictValueName',
                    pidKey: 'parentTreeNodeStr',
                    callback: {
                        onClick: function (event, treeId, treeNode) {
                            console.log(treeNode);
                            //detroyMenuContext();
                            if (treeNode.getParentNode()) {
                                treeNode.parentDictValueName = treeNode.getParentNode().dictValueName;
                            }
                            DF.initCustomFormPlaceHolder($form);
                            $form.reset();
                            DF.setFormValues(treeNode, $form);
                            $('#delDictValue').removeClass('disabled').removeAttr('disabled');
                            $('#parentDictItemCode1').val(treeNode.dictItemCode);
                            currentNode = treeNode;
                            //如果自动加载字典值
                            //displayOrShow();
                        },
                        onAsyncSuccess: function (event, treeId, treeNode, msg) {
                            clickTreeSelectNode(dictValueTree);
                        }
                    },
                    onComplete: function (treeObject) {
                        if (!addDataDictValueFlag) {
                            clickTreeFirstNode(dictValueTree);
                        }
                    }
                });
            }
            function initPage() {
                $('#dictValueSubmit').on('click', function (event) {
                    //保存表单or编辑表单  走后台
                    var form = $form;
                    var data = form.serializeObject();
                    //字典值是否重复
                    submit(data, false);
                });

                function processResult(d) {
                    if (d.errorCode == '1800') {
                        //提示有重复
                        DF.toast.error("字典值编码重复");
                        //清空数据
                        $("#dictValueCode").val("");
                        //设置焦点
                        $("#dictValueCode").focus();
                    } else if (d.errorCode == '1801') {
                        DF.toast.error(d.message);
                        //清空数据
                        $("#dictValueName").val("");
                        //设置焦点
                        $("#dictValueName").focus();
                    } else if (d.errorCode == '1802') {
                        DF.toast.error(d.message);
                        //清空数据
                        $("#dictValueCode").val("");
                        //设置焦点
                        $("#dictValueCode").focus();
                    } else if (d.errorCode == '1803') {
                        DF.confirm("数据字典值名称重复，确认继续添加？", "提示", function () {
                            var form = $form;
                            var data = form.serializeObject();
                            submit(data, true);
                        });
                        $("#dictValueName").focus();
                    } else if (d.errorCode == '1') {
                        DF.toast.success(d.message);
                        reloadTree(dictValueTree);
                    }
                }

                function submit(d, flag) {
                    if (d.dictValueId == "" || d.dictValueId == undefined) {
                        DF.ajax({
                            data: JSON.stringify(d),
                            type: 'post',
                            url: 'dataDict/addValue?flag=' + flag,
                            success: function (data, status) {
                                debugger;
                                processResult(data);
                            }
                        });
                    } else {
                        DF.ajax({
                            data: JSON.stringify(d),
                            type: 'put',
                            url: 'dataDict/editValue?flag=' + flag,
                            success: function (data, status) {
                                debugger;
                                processResult(data);
                            }
                        });
                    }
                }

//                $('#dictValueAdd').on('click', function (event) {
//                    var subNode = {
//                        dictValueId: "",
//                        dictItemCode: "",
//                        dictValueCode: "",
//                        dictValueName: "",
//                        dictValueDesc: "",
//                        parentDictValueCode: "",
//                        parentDictValueName: "",
//                        sortNum: ""
//                    };
//                    DF.setFormValues(subNode, $form);
//                    DF.initCustomFormPlaceHolder($form);
//                });

                $('#dictValueSameLevelAdd').on('click', function (event) {
                    debugger;
                    if (dictValueTree.getSelectedNodes().length) {
                        var parentItemC;
                        if (currentNode.parentDictItemCode == undefined || currentNode.parentDictItemCode == "") {
                            parentItemC = currentNode.dictItemCode;
                        } else {
                            parentItemC = currentNode.parentDictItemCode;
                        }
                        var subNode = {
                            dictValueId: "",
                            dictItemCode: parentItemC,
                            dictValueCode: "",
                            dictValueName: "",
                            dictValueDesc: "",
                            sortNum: "",
                            parentDictItemCode:parentItemC,
                            parentDictValueCode: currentNode.parentDictValueCode,
                            parentDictValueName: currentNode.parentDictValueName
                        };
                        DF.setFormValues(subNode, $form);
                        $('#parentDictItemCode1').val(parentItemC);
                        DF.initCustomFormPlaceHolder($form);
                        //displayOrShow(true);
                    } else {
                        DF.toast.warning('请选择一个节点!');
                    }
                });


                $('#dictValueSubAdd').on('click', function (event) {
                    if (dictValueTree.getSelectedNodes().length) {
                        var subNode = {
                            dictValueId: "",
                            dictItemCode: "",
                            dictValueCode: "",
                            dictValueName: "",
                            dictValueDesc: "",
                            sortNum: "",
                            parentDictItemCode: currentNode.dictItemCode,
                            parentDictValueCode: currentNode.dictValueCode,
                            parentDictValueName: currentNode.dictValueName
                        };
                        DF.setFormValues(subNode, $form);
                        $('#parentDictItemCode1').val(currentNode.dictItemCode);
                        DF.initCustomFormPlaceHolder($form);
                        //displayOrShow(true);
                    } else {
                        DF.toast.warning('请选择一个节点!');
                    }
                });
                $('#delDictValue').on('click', function (event) {
                    DF.confirm('确认删除此字典值？').done(function () {
                        DF.ajax({
                            type: 'delete',
                            url: 'dataDict/deleteValue/' + dictValueTree.getSelectedNodes()[0].dictValueId,
                            success: function (data, status) {
                                DF.toast.success(data.message);
                                reloadTree(dictValueTree);
                            }
                        });
                    });
                });
            }

            //显示隐藏 按钮 panel
            function displayOrShow(flag) {
                if (currentNode.id == -1 && !flag) {
                    $('.displayBtn').addClass('hidden');
                    $('.readOnlyField').attr('readonly', 'readonly');
                } else {
                    $('.displayBtn').removeClass('hidden');
                    $('.readOnlyField').removeAttr('readonly');
                }
                if (!!$('#autoLoadDictValue:checked').length) {
                    $('#loadDictValue').trigger('click');
                } else {
                    $("#dictValueCmt").parent().addClass("hidden");
                }
            }

            initPage();
            var result = {};
            result[selector] = exports;
            DF.callbackComponent(result);
        })(jQuery);
        ]]>
</script>
