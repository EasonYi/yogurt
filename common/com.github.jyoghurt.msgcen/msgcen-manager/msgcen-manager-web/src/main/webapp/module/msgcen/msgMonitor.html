<!-- Basic Setup Start-->
<div class="panel panel-default wash-clothes-wrapper">
    <div class="panel-heading">
        <h3 class="panel-title">消息监控</h3>
        <div class="panel-options">
            <a href="#" data-toggle="panel">
                <span class="collapse-icon">&ndash;</span>
                <span class="expand-icon">+</span>
            </a>
            <!-- 关闭
                <a href="#" data-toggle="remove">
                &times;
            </a>
            -->
        </div>
    </div>
    <div class="panel-body">
        <table id="table" class="table  table-bordered table-hover" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>id</th>
                <th>消息模板类型</th>
                <th>消息模板Code</th>
                <th>消息优先级</th>
                <th>消息发送状态</th>
                <th>消息发送目标</th>
                <th>消息发送时间</th>
                <th class="width130">操作</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <script type="text/javascript">
            (function ($) {
                DF.load('js/multipleSearchGrid.js',function (){
                    var searchConfig = {
                        id: "table",
                        ajax: "msg/list",
                        rowbtns: [
                            {text: '编辑', name: 'edit', class: 'btn-success', fn: editRow}
                        ],
                        searchForm:{
                            searchField:{name:'target',text:'消息发送目标'},
                            inputFieldList :[{name:'msgTmplCode',text:'模板编号'}],
                            selectSearchList: [
                                {
                                    title: '消息类型',
                                    url: 'dataDict/getDataDictValuesByItemCode/MsgType',
                                    name: 'msgType',
                                    key: "dictValueCode",
                                    parseValue: "dictValueName",
                                    className: "form-control",
                                    width: "300px"
                                },
                                {
                                    title: '发送状态',
                                    url: 'dataDict/getDataDictValuesByItemCode/MsgSendStatusEnum',
                                    name: 'msgStatus',
                                    key: "dictValueCode",
                                    parseValue: "dictValueName",
                                    className: "form-control",
                                    width: "300px"
                                }
                            ]
                        },
                        columns: [
                            {"data": "msgId", "orderable": false, "visible": false},
                            {"data": "msgTypeValue", "orderable": false},
                            {"data": "msgTmplCode", "orderable": false},
                            {"data": "msgLevelValue", "orderable": false},
                            {"data": "msgStatusValue", "orderable": false},
                            {"data": "target", "orderable": false},
                            {"data": "createDateTime", "orderable": false}
                        ],
                        //表单详情
                        viewForm: $('#msgForm'),

                        //重新加载
                        reloadGrid: reloadGrid,
                        //初始化结束后回调
                        initComplete: function () {
                        }
                    };
                    var searchGrid = $('#table').multipleSearchGrid(searchConfig);


                    /**
                     *编辑或者新建 逻辑判断 无后台
                     * rowdata 行数据
                     */
                    function editRow(rowdata) {
                        //编辑还是保存
                        var flag = rowdata ? true : false;
                        //弹出菜单的业务逻辑方法
                        function saveHandler(modal) {
                            saveOrUPdate(modal, flag, function (data, status) {
                                DF.toast.success(data.message);
                                DF.hideModal(modal);
                                reloadGrid();
                            });
                        }

                        //modal窗口的配置项目
                        var config = {
                            dom: $('#msgForm'),
                            title: flag ? '编辑页面' : '新建页面',
                            cache: false,
                            btns: [{
                                text: '保存',
                                icon: 'btn-info',
                                fn: saveHandler
                            }]
                        };
                        DF.showModal(config, function (modal) {
                            /*回调函数中的参数
                             * modal为当前的模块窗口 其中提供 getForm()方法 返回 业务的form 此form为 jq对象
                             */
                            flag && loadForm(modal, rowdata);
                        });
                    };
                    //删除 走后台
                    function deleteRow(rowdata) {
                        if (confirm('确认删除吗？')) {
                            var url = 'msg/' + rowdata.msgId;
                            var sfn = function (data, status) {
                                reloadGrid();
                                DF.toast.success(data.message);
                            };
                            DF.ajax({
                                type: 'delete',
                                url: url,
                                success: sfn
                            });
                        }
                    };
                    //加载列表  走后台
                    function reloadGrid() {
                        searchGrid.loadGrid();
                    };
                    //加载表单  如果rowdata 数据满足  可以直接赋值 不用走后台
                    function loadForm(modal, rowdata) {
                        var form = modal.getForm();
                        if (rowdata) {
                            DF.setFormValues(rowdata, form);
                        }
    //                    var url = 'msg/'+rowdata.msgId;
    //                    var sfn = function(data,status){
    //                        DF.setFormValues(data,form);
    //                    };
    //                    DF.ajax({
    //                        url:url,
    //                        success:sfn
    //                    });
                    };
                    //保存表单or编辑表单  走后台
                    function saveOrUPdate(modal, flag, fn) {
                        var form = modal.getForm();
                        var data = form.serializeObject();
                        var sfn = function (data, status) {
                            fn && fn(data, status);
                        };
                        DF.ajax({
                            data: JSON.stringify(data),
                            type: flag ? 'put' : 'post',
                            url: 'msg',
                            dataType: 'json',
                            success: sfn
                        });
                    }

                });
            })(jQuery);
        </script>
    </div>
</div>
<!-- Basic Setup  End-->
<script type="text/template" id="msgForm">
    <form class="validate">
        <div class="row">
            <div class="col-md-12">
                <div class="form-group hidden">
                    <label class="control-label"></label>
                    <input type="text" name="msgId">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="msgTmplCode" class="control-label">消息模板Id</label>
                    <input type="text" name="msgTmplCode" class="form-control" id="msgTmplCode"
                           placeholder="" required maxlength="128">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="param" class="control-label">消息参数</label>
                    <input type="text" name="param" class="form-control" id="param"
                           placeholder="" required maxlength="10000">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="msgLevelValue" class="control-label">消息优先级</label>
                    <input type="text" name="msgLevelValue" class="form-control" id="msgLevelValue"
                           placeholder="" required maxlength="12">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="msgStatusValue" class="control-label">消息发送状态</label>
                    <input type="text" name="msgStatusValue" class="form-control" id="msgStatusValue"
                           placeholder="" required maxlength="12">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="target" class="control-label">消息发送目标</label>
                    <input type="text" name="target" class="form-control" id="target"
                           placeholder="" required maxlength="256">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group no-margin">
                    <label for="msgErrorLog" class="control-label">消息异常</label>
                    <textarea type="text" style="height: 500px" name="msgErrorLog" class="form-control" id="msgErrorLog"
                              placeholder="" required maxlength="10000">
                        </textarea>
                </div>
            </div>
        </div>
    </form>
</script>

